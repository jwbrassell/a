{% extends "base.html" %}

{% block title %}On-Call Schedule{% endblock %}

{% block page_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="sticky-top mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Current On-Call</h3>
                        </div>
                        <div class="card-body">
                            <div class="btn-group w-100 mb-3">
                                <button class="btn btn-info">
                                    <i class="fas fa-user me-2"></i>
                                    <span id="current-name">No one currently on call</span>
                                </button>
                                <button class="btn btn-outline-info">
                                    <i class="fas fa-phone me-1"></i>
                                    <span id="current-phone">-</span>
                                </button>
                            </div>
                            <div class="form-group">
                                <label for="team-filter">Filter by Team</label>
                                <select class="form-control" id="team-filter">
                                    <option value="">All Teams</option>
                                    {% for team in teams %}
                                    <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    {% if is_admin %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Upload Schedule</h3>
                        </div>
                        <div class="card-body">
                            {% if teams %}
                            <button type="button" class="btn btn-primary btn-block mb-3" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-upload me-2"></i>Upload Schedule
                            </button>
                            <a href="{{ url_for('static', filename='templates/oncall_template.csv') }}" class="btn btn-secondary btn-block">
                                <i class="fas fa-download me-2"></i>Download Template
                            </a>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Please create a team first before uploading a schedule.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 class="card-title">Teams</h3>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#teamModal">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="team-list">
                                {% for team in teams %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle text-{{ team.color }} me-2"></i>
                                        {{ team.name }}
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" onclick="editTeam({{ team.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="deleteTeam({{ team.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if not teams %}
                                <div class="list-group-item text-center text-muted">
                                    No teams created yet
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-9">
                <div class="card card-primary">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <button type="button" id="prev-month" class="btn btn-default">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button type="button" id="current-month" class="btn btn-default" style="min-width: 150px">
                                    December 2024
                                </button>
                                <button type="button" id="next-month" class="btn btn-default">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <button type="button" id="today" class="btn btn-default">Today</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0" id="calendar-table">
                                <thead>
                                    <tr>
                                        <th class="text-center" style="width: 14.28%">Sun</th>
                                        <th class="text-center" style="width: 14.28%">Mon</th>
                                        <th class="text-center" style="width: 14.28%">Tue</th>
                                        <th class="text-center" style="width: 14.28%">Wed</th>
                                        <th class="text-center" style="width: 14.28%">Thu</th>
                                        <th class="text-center" style="width: 14.28%">Fri</th>
                                        <th class="text-center" style="width: 14.28%">Sat</th>
                                    </tr>
                                </thead>
                                <tbody id="calendar-body">
                                    <!-- Calendar rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% if is_admin %}
<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="upload-form" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>Upload Schedule
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="team" class="form-label">Team</label>
                        <select class="form-control" id="team" name="team" required>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="year" class="form-label">Year</label>
                        <input type="number" class="form-control" id="year" name="year" 
                            value="{{ now.year }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="file" class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="file" name="file" 
                            accept=".csv" required>
                        <div class="form-text">
                            Required columns: week, name, phone
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Team Modal -->
<div class="modal fade" id="teamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="team-form">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users me-2"></i><span id="team-modal-title">Add Team</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="team-id">
                    <div class="mb-3">
                        <label for="team-name" class="form-label">Team Name</label>
                        <input type="text" class="form-control" id="team-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Team Color</label>
                        <div class="btn-group w-100" role="group">
                            {% for color in ['primary', 'secondary', 'success', 'danger', 'warning', 'info'] %}
                            <input type="radio" class="btn-check" name="team-color" id="color-{{ color }}" 
                                   value="{{ color }}" {% if color == 'primary' %}checked{% endif %}>
                            <label class="btn btn-outline-{{ color }}" for="color-{{ color }}">
                                <i class="fas fa-circle"></i>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block styles %}
{{ super() }}
<style>
#calendar-table {
    table-layout: fixed;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

#calendar-table th {
    background-color: #f4f6f9;
    font-weight: 600;
    padding: 15px;
    text-transform: uppercase;
    font-size: 0.875rem;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
}

#calendar-table td {
    height: 130px;
    padding: 12px;
    vertical-align: top;
    background: white;
    position: relative;
    border: 1px solid #dee2e6;
}

#calendar-table tr:first-child td {
    border-top: none;
}

#calendar-table tr td:first-child {
    border-left: none;
}

#calendar-table tr:last-child td {
    border-bottom: none;
}

#calendar-table tr td:last-child {
    border-right: none;
}

#calendar-table tr:nth-child(2n) td {
    border-top: 2px solid #dee2e6;
}

#calendar-table td.other-month {
    background-color: #f8f9fa;
}

#calendar-table td.today {
    background-color: #fff8e6;
}

#calendar-table td.handoff-day {
    background: linear-gradient(to bottom, var(--prev-color) 50%, var(--next-color) 50%);
}

#calendar-table td.handoff-day::after {
    content: '5 PM';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75em;
    color: #666;
    border: 1px solid #dee2e6;
}

.date-number {
    font-size: 1.2em;
    font-weight: 500;
    margin-bottom: 10px;
    color: #495057;
    position: relative;
    z-index: 1;
}

.other-month .date-number {
    color: #adb5bd;
}

.on-call-event {
    padding: 8px 12px;
    margin: 4px 0;
    border-radius: 4px;
    color: white;
    font-size: 0.95em;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    position: relative;
    z-index: 2;
}

.on-call-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}

.on-call-event.ending {
    border-bottom: 2px dashed rgba(255,255,255,0.5);
}

.on-call-event.starting {
    border-top: 2px dashed rgba(255,255,255,0.5);
}

.table-responsive {
    height: calc(100vh - 250px);
    overflow-y: auto;
}

.card-header .btn-group .btn {
    box-shadow: none;
}

#current-month {
    font-weight: 500;
}

/* Tooltip customization */
.tooltip .tooltip-inner {
    max-width: 300px;
    padding: 8px 12px;
    background-color: #343a40;
    font-size: 0.9em;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Team color buttons */
.btn-check:checked + .btn-outline-primary,
.btn-check:checked + .btn-outline-secondary,
.btn-check:checked + .btn-outline-success,
.btn-check:checked + .btn-outline-danger,
.btn-check:checked + .btn-outline-warning,
.btn-check:checked + .btn-outline-info {
    color: white;
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var currentDate = new Date();
    var currentMonth = currentDate.getMonth();
    var currentYear = currentDate.getFullYear();
    var selectedTeam = '';
    
    // API endpoints
    var urls = {
        events: "{{ url_for('oncall.get_events') }}",
        current: "{{ url_for('oncall.get_current_oncall') }}",
        upload: "{{ url_for('oncall.upload_oncall') }}",
        teams: "{{ url_for('oncall.manage_teams') }}"
    };
    
    // Team filter handler
    document.getElementById('team-filter').onchange = function() {
        selectedTeam = this.value;
        updateCalendar();
        loadCurrentOnCall();
    };
    
    function updateCalendar() {
        // Update month/year display
        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                         'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('current-month').textContent = monthNames[currentMonth] + ' ' + currentYear;
        
        // Get first day of month and number of days
        var firstDay = new Date(currentYear, currentMonth, 1);
        var lastDay = new Date(currentYear, currentMonth + 1, 0);
        
        // Prepare URL with team filter if selected
        var params = {
            start: new Date(currentYear, currentMonth, 1).toISOString(),
            end: new Date(currentYear, currentMonth + 1, 0).toISOString()
        };
        if (selectedTeam) {
            params.team = selectedTeam;
        }
        
        // Get events for this month
        fetch(urls.events + "?" + new URLSearchParams(params))
        .then(response => response.json())
        .then(events => {
            var calendarBody = document.getElementById('calendar-body');
            calendarBody.innerHTML = '';
            
            var date = 1;
            var today = new Date();
            
            // Create calendar rows
            for (var i = 0; i < 6; i++) {
                var row = document.createElement('tr');
                
                for (var j = 0; j < 7; j++) {
                    var cell = document.createElement('td');
                    
                    if (i === 0 && j < firstDay.getDay()) {
                        // Previous month days
                        var prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
                        var day = prevMonthDays - firstDay.getDay() + j + 1;
                        cell.innerHTML = `<div class="date-number">${day}</div>`;
                        cell.classList.add('other-month');
                    }
                    else if (date > lastDay.getDate()) {
                        // Next month days
                        var nextDate = date - lastDay.getDate();
                        cell.innerHTML = `<div class="date-number">${nextDate}</div>`;
                        cell.classList.add('other-month');
                        date++;
                    }
                    else {
                        // Current month days
                        cell.innerHTML = `<div class="date-number">${date}</div>`;
                        
                        // Check if this is today
                        if (currentYear === today.getFullYear() && 
                            currentMonth === today.getMonth() && 
                            date === today.getDate()) {
                            cell.classList.add('today');
                        }
                        
                        // Add events for this day
                        var cellDate = new Date(currentYear, currentMonth, date);
                        var dayEvents = events.filter(event => {
                            var eventStart = new Date(event.start);
                            var eventEnd = new Date(event.end);
                            return cellDate >= eventStart && cellDate < eventEnd;
                        });

                        // Check for handoff day (Friday)
                        if (j === 5) { // Friday
                            var handoffEvents = events.filter(event => {
                                var eventStart = new Date(event.start);
                                return eventStart.getDate() === date &&
                                       eventStart.getMonth() === currentMonth &&
                                       eventStart.getFullYear() === currentYear;
                            });

                            if (handoffEvents.length > 0) {
                                // Find the previous event
                                var prevEvent = events.find(event => {
                                    var eventEnd = new Date(event.end);
                                    return eventEnd.getDate() === date &&
                                           eventEnd.getMonth() === currentMonth &&
                                           eventEnd.getFullYear() === currentYear;
                                });

                                if (prevEvent) {
                                    cell.classList.add('handoff-day');
                                    cell.style.setProperty('--prev-color', prevEvent.backgroundColor + '80');
                                    cell.style.setProperty('--next-color', handoffEvents[0].backgroundColor + '80');
                                }
                            }
                        }

                        dayEvents.forEach(event => {
                            var eventDiv = document.createElement('div');
                            eventDiv.className = 'on-call-event ' + event.classNames.join(' ');
                            eventDiv.textContent = event.title;
                            
                            // Add dashed border for handoff days
                            var eventStart = new Date(event.start);
                            var eventEnd = new Date(event.end);
                            if (eventStart.getDate() === date) {
                                eventDiv.classList.add('starting');
                            }
                            if (new Date(eventEnd - 1).getDate() === date) {
                                eventDiv.classList.add('ending');
                            }
                            
                            eventDiv.setAttribute('data-bs-toggle', 'tooltip');
                            eventDiv.setAttribute('data-bs-title', 
                                `On Call: ${event.title}\nPhone: ${event.extendedProps.phone}\nTeam: ${event.extendedProps.team}`);
                            cell.appendChild(eventDiv);
                            
                            new bootstrap.Tooltip(eventDiv);
                        });
                        
                        date++;
                    }
                    
                    row.appendChild(cell);
                }
                
                calendarBody.appendChild(row);
                
                // Stop if we've displayed all days
                if (date > lastDay.getDate()) {
                    break;
                }
            }
        });
    }
    
    // Navigation handlers
    document.getElementById('prev-month').onclick = function() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        updateCalendar();
    };
    
    document.getElementById('next-month').onclick = function() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        updateCalendar();
    };
    
    document.getElementById('today').onclick = function() {
        currentMonth = currentDate.getMonth();
        currentYear = currentDate.getFullYear();
        updateCalendar();
    };
    
    // Current on-call information
    function loadCurrentOnCall() {
        var params = {};
        if (selectedTeam) {
            params.team = selectedTeam;
        }
        
        fetch(urls.current + "?" + new URLSearchParams(params))
            .then(function(response) {
                if (!response.ok) throw new Error('No one currently on call');
                return response.json();
            })
            .then(function(data) {
                if (data.error) throw new Error(data.error);
                document.getElementById('current-name').textContent = data.name;
                document.getElementById('current-phone').textContent = data.phone;
            })
            .catch(function(error) {
                document.getElementById('current-name').textContent = 'No one currently on call';
                document.getElementById('current-phone').textContent = '-';
            });
    }
    
    loadCurrentOnCall();
    setInterval(loadCurrentOnCall, 60000);
    
    {% if is_admin %}
    // Team management
    document.getElementById('team-form').onsubmit = function(e) {
        e.preventDefault();
        
        var teamId = document.getElementById('team-id').value;
        var teamName = document.getElementById('team-name').value;
        var teamColor = document.querySelector('input[name="team-color"]:checked').value;
        
        var data = {
            name: teamName,
            color: teamColor
        };
        
        var method = teamId ? 'PUT' : 'POST';
        var url = teamId ? 
            urls.teams + '/' + teamId :
            urls.teams;
            
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Network response was not ok');
                });
            }
            return response.json();
        })
        .then(function(data) {
            if (data.error) {
                toastr.error(data.error);
            } else {
                toastr.success('Team saved successfully');
                location.reload();  // Refresh to update team list
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            toastr.error('Error saving team: ' + error.message);
        });
    };
    
    window.editTeam = function(teamId) {
        fetch(urls.teams + '/' + teamId)
            .then(response => response.json())
            .then(function(team) {
                document.getElementById('team-id').value = team.id;
                document.getElementById('team-name').value = team.name;
                document.getElementById('color-' + team.color).checked = true;
                document.getElementById('team-modal-title').textContent = 'Edit Team';
                new bootstrap.Modal(document.getElementById('teamModal')).show();
            });
    };
    
    window.deleteTeam = function(teamId) {
        if (confirm('Are you sure you want to delete this team?')) {
            fetch(urls.teams + '/' + teamId, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                }
            })
            .then(function(response) {
                if (response.ok) {
                    toastr.success('Team deleted successfully');
                    location.reload();  // Refresh to update team list
                } else {
                    toastr.error('Error deleting team');
                }
            });
        }
    };
    
    document.getElementById('upload-form').onsubmit = function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        var submitButton = this.querySelector('button[type="submit"]');
        var originalContent = submitButton.innerHTML;
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Uploading...';
        
        fetch(urls.upload, {
            method: 'POST',
            body: formData
        })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.error) {
                    toastr.error(data.error);
                } else {
                    toastr.success(data.message);
                    updateCalendar();
                    loadCurrentOnCall();
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                toastr.error('An error occurred while uploading the file');
            })
            .finally(function() {
                submitButton.disabled = false;
                submitButton.innerHTML = originalContent;
            });
    };
    {% endif %}
    
    // Initial calendar render
    updateCalendar();
});
</script>
{% endblock %}
