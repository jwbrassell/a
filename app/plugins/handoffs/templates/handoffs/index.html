{% extends "base.html" %}

{% block title %}Handoffs{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <!-- Priority Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-info bg-opacity-10">
                <div class="card-body">
                    <h5 class="card-title">Low Priority</h5>
                    <p class="card-text display-4">
                        {{ open_handoffs|selectattr('priority', 'equalto', 'low')|list|length }}
                    </p>
                    <p class="text-muted">Open Handoffs</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning bg-opacity-10">
                <div class="card-body">
                    <h5 class="card-title">Medium Priority</h5>
                    <p class="card-text display-4">
                        {{ open_handoffs|selectattr('priority', 'equalto', 'medium')|list|length }}
                    </p>
                    <p class="text-muted">Open Handoffs</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger bg-opacity-10">
                <div class="card-body">
                    <h5 class="card-title">High Priority</h5>
                    <p class="card-text display-4">
                        {{ open_handoffs|selectattr('priority', 'equalto', 'high')|list|length }}
                    </p>
                    <p class="text-muted">Open Handoffs</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="{{ url_for('handoffs.create') }}" class="btn btn-primary me-2">
                    <i class="fas fa-plus"></i> New Handoff
                </a>
                <a href="{{ url_for('handoffs.metrics') }}" class="btn btn-info">
                    <i class="fas fa-chart-line"></i> View Metrics
                </a>
            </div>
        </div>
    </div>

    <!-- Open Handoffs -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Open Handoffs</h3>
        </div>
        <div class="card-body">
            <table class="table" id="openHandoffsTable">
                <thead>
                    <tr class="header-row">
                        <th>Priority</th>
                        <th>Ticket</th>
                        <th>Assigned</th>
                        <th>Due Date</th>
                        <th>KIRKE</th>
                        <th>Hostname</th>
                        <th>Notes</th>
                        <th>Bridge</th>
                        <th>Name</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                    <tr class="filter-row">
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Priority"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Ticket"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Assigned"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Due Date"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search KIRKE"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Hostname"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Notes"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Bridge"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Name"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Created"></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for handoff in open_handoffs %}
                    <tr class="table-{{ 'danger' if handoff.priority == 'high' 
                                    else 'warning' if handoff.priority == 'medium' 
                                    else 'info' }}">
                        <td>
                            <span class="badge bg-{{ 'danger' if handoff.priority == 'high' 
                                                else 'warning' if handoff.priority == 'medium' 
                                                else 'info' }}">
                                {{ handoff.priority|title }}
                            </span>
                        </td>
                        <td>{{ handoff.ticket or 'N/A' }}</td>
                        <td><span class="badge bg-shift">{{ handoff.assigned_to }} Shift</span></td>
                        <td>{{ handoff.due_date.strftime('%Y-%m-%d %H:%M') if handoff.due_date else 'N/A' }}</td>
                        <td>{{ handoff.kirke or 'N/A' }}</td>
                        <td>{{ handoff.hostname or 'N/A' }}</td>
                        <td>{{ handoff.description|safe }}</td>
                        <td>
                            {% if handoff.has_bridge and handoff.bridge_link %}
                            <a href="{{ handoff.bridge_link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-video"></i> Join
                            </a>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>{{ handoff.reporter_user.username }}</td>
                        <td>{{ handoff.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <button class="btn btn-sm btn-success close-handoff" 
                                    data-id="{{ handoff.id }}"
                                    data-csrf-token="{{ csrf_token() }}">
                                <i class="fas fa-check"></i> Close
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Closed Handoffs -->
    <div class="card mt-4">
        <div class="card-header">
            <h3 class="card-title">Closed Handoffs</h3>
        </div>
        <div class="card-body">
            <table class="table" id="closedHandoffsTable">
                <thead>
                    <tr class="header-row">
                        <th>Priority</th>
                        <th>Ticket</th>
                        <th>Assigned</th>
                        <th>Due Date</th>
                        <th>KIRKE</th>
                        <th>Hostname</th>
                        <th>Notes</th>
                        <th>Bridge</th>
                        <th>Name</th>
                        <th>Created</th>
                        <th>Closed</th>
                    </tr>
                    <tr class="filter-row">
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Priority"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Ticket"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Assigned"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Due Date"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search KIRKE"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Hostname"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Notes"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Bridge"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Name"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Created"></th>
                        <th><input type="text" class="form-control form-control-sm" placeholder="Search Closed"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for handoff in closed_handoffs %}
                    <tr class="table-{{ 'danger' if handoff.priority == 'high' 
                                    else 'warning' if handoff.priority == 'medium' 
                                    else 'info' }}">
                        <td>
                            <span class="badge bg-{{ 'danger' if handoff.priority == 'high' 
                                                else 'warning' if handoff.priority == 'medium' 
                                                else 'info' }}">
                                {{ handoff.priority|title }}
                            </span>
                        </td>
                        <td>{{ handoff.ticket or 'N/A' }}</td>
                        <td><span class="badge bg-shift">{{ handoff.assigned_to }} Shift</span></td>
                        <td>{{ handoff.due_date.strftime('%Y-%m-%d %H:%M') if handoff.due_date else 'N/A' }}</td>
                        <td>{{ handoff.kirke or 'N/A' }}</td>
                        <td>{{ handoff.hostname or 'N/A' }}</td>
                        <td>{{ handoff.description|safe }}</td>
                        <td>
                            {% if handoff.has_bridge and handoff.bridge_link %}
                            <a href="{{ handoff.bridge_link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-video"></i> Join
                            </a>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>{{ handoff.reporter_user.username }}</td>
                        <td>{{ handoff.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ handoff.closed_at.strftime('%Y-%m-%d %H:%M') if handoff.closed_at else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Updating Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<!-- Export Libraries -->
<script src="{{ url_for('static', filename='src/jszip/jszip.min.js') }}"></script>
<script src="{{ url_for('static', filename='src/pdfmake/pdfmake.min.js') }}"></script>
<script src="{{ url_for('static', filename='src/pdfmake/vfs_fonts.js') }}"></script>

<script>
$(document).ready(function() {
    // Function to setup DataTable
    function setupDataTable(tableId, hasActions = false) {
        const table = $(`#${tableId}`).DataTable({
            order: [[9, 'desc']],  // Sort by created date by default
            dom: '<"table-controls"<"row"<"col-sm-6 offset-sm-2"f><"col-sm-4"B>>>rtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    className: 'btn btn-secondary'
                },
                {
                    extend: 'csvHtml5',
                    className: 'btn btn-secondary'
                },
                {
                    extend: 'pdfHtml5',
                    className: 'btn btn-secondary'
                }
            ],
            orderCellsTop: true,
            initComplete: function () {
                const api = this.api();
                api.columns().every(function(index) {
                    if (hasActions && index === api.columns().nodes().length - 1) {
                        return;
                    }
                    
                    const that = this;
                    $('input', this.header()).on('keyup change clear', function() {
                        if (that.search() !== this.value) {
                            that.search(this.value).draw();
                        }
                    });
                });

                const wrapper = $(this).closest('.dataTables_wrapper');
                wrapper.find('.table-controls').css('justify-content', 'flex-end');
                wrapper.find('.dataTables_filter').css('margin-right', '20px');
            }
        });
    }

    // Initialize tables
    setupDataTable('openHandoffsTable', true);
    setupDataTable('closedHandoffsTable', false);

    // Initialize the status update modal
    const statusModal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));

    // Handle close handoff
    $('.close-handoff').click(function() {
        const button = $(this);
        const handoffId = button.data('id');
        const csrfToken = button.data('csrf-token');
        
        statusModal.show();

        $.ajax({
            url: `/handoffs/${handoffId}/close`,
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            success: function(response) {
                if (response.status === 'success') {
                    statusModal.hide();
                    location.reload();
                } else {
                    statusModal.hide();
                    alert('Error closing handoff: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                statusModal.hide();
                console.error('Error:', error);
                alert('An error occurred while closing the handoff. Please try again.');
            }
        });
    });
});
</script>
{% endblock %}
