{% extends "base.html" %}

{% block title %}Create Handoff{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('handoffs.index') }}">Handoffs</a></li>
    <li class="breadcrumb-item active">Create</li>
</ol>
{% endblock %}

{% block page_content %}
<div class="modal fade show" id="createHandoffModal" tabindex="-1" aria-labelledby="createHandoffModalLabel" aria-modal="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createHandoffModalLabel">Create Handoff</h5>
                <a href="{{ url_for('handoffs.index') }}" class="btn-close" aria-label="Close"></a>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('handoffs.create') }}" id="handoffForm" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.assigned_to.label(class="form-label") }}
                            {{ form.assigned_to(class="form-select select2") }}
                            {% if form.assigned_to.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.assigned_to.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.ticket.label(class="form-label") }}
                            {{ form.ticket(class="form-control") }}
                            {% if form.ticket.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.ticket.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.hostname.label(class="form-label") }}
                            {{ form.hostname(class="form-control") }}
                            {% if form.hostname.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.hostname.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.kirke.label(class="form-label") }}
                            {{ form.kirke(class="form-control") }}
                            {% if form.kirke.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.kirke.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.due_date.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.due_date(class="form-control", type="datetime-local", id="due_date") }}
                                <span class="input-group-text">
                                    <i class="fas fa-calendar"></i>
                                </span>
                            </div>
                            {% if form.due_date.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.due_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.priority.label(class="form-label") }}
                            {{ form.priority(class="form-select select2") }}
                            {% if form.priority.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.priority.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.has_bridge(class="form-check-input") }}
                            {{ form.has_bridge.label(class="form-check-label") }}
                        </div>
                    </div>

                    <div class="mb-3" id="bridgeLinkField" style="display: none;">
                        {{ form.bridge_link.label(class="form-label") }}
                        {{ form.bridge_link(class="form-control") }}
                        {% if form.bridge_link.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.bridge_link.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control tinymce") }}
                        <div id="description-error" class="invalid-feedback" style="display: none;">
                            Description is required
                        </div>
                        {% if form.description.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.description.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="modal-footer">
                        <a href="{{ url_for('handoffs.index') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade show"></div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Show modal on page load
    $('#createHandoffModal').modal('show');

    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dropdownParent: $('#createHandoffModal'),
        minimumResultsForSearch: -1  // Disable search
    });

    // Show/hide bridge link field based on checkbox
    $('#has_bridge').change(function() {
        if ($(this).is(':checked')) {
            $('#bridgeLinkField').slideDown();
        } else {
            $('#bridgeLinkField').slideUp();
            $('#bridge_link').val('');
        }
    });

    // Set initial state of bridge link field
    if ($('#has_bridge').is(':checked')) {
        $('#bridgeLinkField').show();
    }

    // Initialize TinyMCE
    tinymce.init({
        selector: '.tinymce',
        height: 200,
        menubar: false,
        statusbar: false,
        plugins: [
            'lists'
        ],
        toolbar: 'bold italic | bullist numlist',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
        setup: function(editor) {
            editor.on('keyup', function(e) {
                var content = editor.getContent({format: 'text'});
                if (content.length > 300) {
                    editor.setContent(content.substr(0, 300));
                }
                $('#description-error').hide();
            });
        }
    });

    // Handle form submission
    $('#handoffForm').on('submit', function(e) {
        e.preventDefault();
        
        // Get TinyMCE content
        var content = tinymce.activeEditor ? tinymce.activeEditor.getContent().trim() : '';
        
        // Validate content
        if (!content) {
            $('#description-error').show();
            return false;
        }
        
        // Update textarea with TinyMCE content
        $('#description').val(content);
        
        // Submit the form
        this.submit();
    });
});
</script>
{% endblock %}
