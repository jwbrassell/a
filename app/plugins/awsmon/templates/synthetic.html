{% extends "base.html" %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Synthetic Tests</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('awsmon.dashboard') }}">AWS Monitor</a></li>
                    <li class="breadcrumb-item active">Synthetic Tests</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Test Summary Cards -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 id="total-tests">0</h3>
                        <p>Total Tests</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-vial"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 id="passing-tests">0</h3>
                        <p>Passing Tests</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3 id="failing-tests">0</h3>
                        <p>Failing Tests</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3 id="disabled-tests">0</h3>
                        <p>Disabled Tests</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-ban"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Test List -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Synthetic Tests</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-primary" onclick="showNewTestModal()">
                                <i class="fas fa-plus"></i> New Test
                            </button>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap" id="tests-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Target</th>
                                    <th>Instance</th>
                                    <th>Frequency</th>
                                    <th>Status</th>
                                    <th>Last Run</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Test Results History</h3>
                        <div class="card-tools">
                            <div class="btn-group">
                                <button type="button" class="btn btn-tool dropdown-toggle" data-toggle="dropdown">
                                    <i class="fas fa-calendar"></i> Time Range
                                </button>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="#" onclick="updateTimeRange(1)">Last Hour</a>
                                    <a class="dropdown-item" href="#" onclick="updateTimeRange(24)">Last 24 Hours</a>
                                    <a class="dropdown-item" href="#" onclick="updateTimeRange(168)">Last Week</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="resultsChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Latest Results</h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group" id="latest-results">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- New Test Modal -->
<div class="modal fade" id="newTestModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Synthetic Test</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newTestForm">
                    <div class="form-group">
                        <label for="testName">Test Name</label>
                        <input type="text" class="form-control" id="testName" required>
                    </div>
                    <div class="form-group">
                        <label for="testType">Test Type</label>
                        <select class="form-control" id="testType" required>
                            <option value="ping">Ping</option>
                            <option value="traceroute">Traceroute</option>
                            <option value="port_check">Port Check</option>
                            <option value="http">HTTP Check</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="testTarget">Target</label>
                        <input type="text" class="form-control" id="testTarget" required>
                        <small class="form-text text-muted">IP address, hostname, or URL</small>
                    </div>
                    <div class="form-group">
                        <label for="testInstance">Source Instance</label>
                        <select class="form-control" id="testInstance" required>
                            {% for instance in instances %}
                            <option value="{{ instance.id }}">{{ instance.name or instance.instance_id }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="testFrequency">Test Frequency (seconds)</label>
                        <input type="number" class="form-control" id="testFrequency" value="60" min="30" required>
                    </div>
                    <div class="form-group">
                        <label for="testTimeout">Timeout (seconds)</label>
                        <input type="number" class="form-control" id="testTimeout" value="5" min="1" required>
                    </div>
                    <div id="additionalParams">
                        <!-- Dynamically populated based on test type -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTest()">Create Test</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="nav-tabs-custom">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#results" data-toggle="tab">Results</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#configuration" data-toggle="tab">Configuration</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="results">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Status</th>
                                            <th>Response Time</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="test-results-body">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane" id="configuration">
                            <form id="testConfigForm">
                                <!-- Populated by JavaScript -->
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let resultsChart;
let currentTimeRange = 24; // hours

function showNewTestModal() {
    $('#newTestModal').modal('show');
    updateAdditionalParams();
}

function updateAdditionalParams() {
    const testType = document.getElementById('testType').value;
    const container = document.getElementById('additionalParams');
    
    let html = '';
    switch(testType) {
        case 'port_check':
            html = `
                <div class="form-group">
                    <label for="port">Port Number</label>
                    <input type="number" class="form-control" id="port" required>
                </div>
            `;
            break;
        case 'http':
            html = `
                <div class="form-group">
                    <label for="method">HTTP Method</label>
                    <select class="form-control" id="method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="HEAD">HEAD</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expectedStatus">Expected Status Code</label>
                    <input type="number" class="form-control" id="expectedStatus" value="200">
                </div>
            `;
            break;
    }
    container.innerHTML = html;
}

document.getElementById('testType').addEventListener('change', updateAdditionalParams);

function createTest() {
    const form = document.getElementById('newTestForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        name: document.getElementById('testName').value,
        type: document.getElementById('testType').value,
        target: document.getElementById('testTarget').value,
        instance_id: document.getElementById('testInstance').value,
        frequency: parseInt(document.getElementById('testFrequency').value),
        timeout: parseInt(document.getElementById('testTimeout').value),
        parameters: {}
    };

    // Add type-specific parameters
    switch(data.type) {
        case 'port_check':
            data.parameters.port = parseInt(document.getElementById('port').value);
            break;
        case 'http':
            data.parameters.method = document.getElementById('method').value;
            data.parameters.expected_status = parseInt(document.getElementById('expectedStatus').value);
            break;
    }

    fetch('{{ url_for("awsmon.manage_tests") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            toastr.success('Test created successfully');
            $('#newTestModal').modal('hide');
            updateTests();
        } else {
            toastr.error(data.message || 'Failed to create test');
        }
    })
    .catch(error => {
        toastr.error('Error creating test: ' + error);
    });
}

function updateTests() {
    fetch('{{ url_for("awsmon.manage_tests") }}')
        .then(response => response.json())
        .then(tests => {
            const tbody = document.querySelector('#tests-table tbody');
            tbody.innerHTML = '';
            
            let passing = 0, failing = 0, disabled = 0;
            
            tests.forEach(test => {
                if (!test.enabled) disabled++;
                else if (test.lastStatus === 'success') passing++;
                else failing++;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${test.name}</td>
                    <td>${test.type}</td>
                    <td>${test.target}</td>
                    <td>${test.instance}</td>
                    <td>${test.frequency}s</td>
                    <td><span class="badge badge-${getStatusBadge(test.enabled, test.lastStatus)}">${getStatusText(test.enabled, test.lastStatus)}</span></td>
                    <td>${formatDateTime(test.lastRun)}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="showTestDetails(${test.id})">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="btn btn-sm ${test.enabled ? 'btn-warning' : 'btn-success'}" onclick="toggleTest(${test.id})">
                                <i class="fas fa-${test.enabled ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTest(${test.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update summary counts
            document.getElementById('total-tests').textContent = tests.length;
            document.getElementById('passing-tests').textContent = passing;
            document.getElementById('failing-tests').textContent = failing;
            document.getElementById('disabled-tests').textContent = disabled;
        });
}

function getStatusBadge(enabled, status) {
    if (!enabled) return 'secondary';
    return status === 'success' ? 'success' : 'danger';
}

function getStatusText(enabled, status) {
    if (!enabled) return 'Disabled';
    return status === 'success' ? 'Passing' : 'Failing';
}

function formatDateTime(timestamp) {
    if (!timestamp) return 'Never';
    return new Date(timestamp).toLocaleString();
}

function updateTimeRange(hours) {
    currentTimeRange = hours;
    updateResults();
}

function updateResults() {
    fetch(`{{ url_for("awsmon.test_results") }}?hours=${currentTimeRange}`)
        .then(response => response.json())
        .then(results => {
            updateResultsChart(results);
            updateLatestResults(results);
        });
}

function updateResultsChart(results) {
    const timeData = {};
    const now = new Date();
    const startTime = new Date(now - currentTimeRange * 60 * 60 * 1000);

    // Initialize time slots
    for (let t = new Date(startTime); t <= now; t.setMinutes(t.getMinutes() + 1)) {
        const key = t.toISOString();
        timeData[key] = { success: 0, failure: 0, timeout: 0 };
    }

    // Fill in actual data
    results.forEach(result => {
        const minute = new Date(result.timestamp);
        minute.setSeconds(0, 0);
        const key = minute.toISOString();
        if (timeData[key]) {
            timeData[key][result.status]++;
        }
    });

    const labels = Object.keys(timeData);
    const successData = labels.map(k => timeData[k].success);
    const failureData = labels.map(k => timeData[k].failure);
    const timeoutData = labels.map(k => timeData[k].timeout);

    if (!resultsChart) {
        const ctx = document.getElementById('resultsChart').getContext('2d');
        resultsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Success',
                        data: successData,
                        borderColor: '#00a65a',
                        fill: false
                    },
                    {
                        label: 'Failure',
                        data: failureData,
                        borderColor: '#f56954',
                        fill: false
                    },
                    {
                        label: 'Timeout',
                        data: timeoutData,
                        borderColor: '#f39c12',
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            stepSize: 1
                        }
                    }]
                }
            }
        });
    } else {
        resultsChart.data.labels = labels;
        resultsChart.data.datasets[0].data = successData;
        resultsChart.data.datasets[1].data = failureData;
        resultsChart.data.datasets[2].data = timeoutData;
        resultsChart.update();
    }
}

function updateLatestResults(results) {
    const container = document.getElementById('latest-results');
    container.innerHTML = results.slice(0, 10).map(result => `
        <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${result.testName}</h6>
                <small>${formatDateTime(result.timestamp)}</small>
            </div>
            <p class="mb-1">
                <span class="badge badge-${getStatusBadge(true, result.status)}">${result.status}</span>
                ${result.response_time ? `${result.response_time}ms` : ''}
            </p>
            ${result.error_message ? `<small class="text-danger">${result.error_message}</small>` : ''}
        </div>
    `).join('');
}

function showTestDetails(testId) {
    // Implement test details view
    $('#testDetailsModal').modal('show');
}

function toggleTest(testId) {
    // Implement test enable/disable
}

function deleteTest(testId) {
    if (confirm('Are you sure you want to delete this test?')) {
        // Implement test deletion
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTests();
    updateResults();
    
    // Set up polling
    setInterval(() => {
        updateTests();
        updateResults();
    }, 60000);
});
</script>
{% endblock %}
