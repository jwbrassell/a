{% extends "base.html" %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">AWS Settings</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('awsmon.dashboard') }}">AWS Monitor</a></li>
                    <li class="breadcrumb-item active">Settings</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- AWS Credentials -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">AWS Credentials</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-primary btn-sm" onclick="showNewCredentialModal()">
                                <i class="fas fa-plus"></i> Add Credentials
                            </button>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Vault Path</th>
                                    <th>Regions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="credentials-table">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Regions -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">AWS Regions</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-primary btn-sm" onclick="showNewRegionModal()">
                                <i class="fas fa-plus"></i> Add Region
                            </button>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Code</th>
                                    <th>Instances</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="regions-table">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jump Server Templates -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Jump Server Templates</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-primary btn-sm" onclick="showNewTemplateModal()">
                                <i class="fas fa-plus"></i> New Template
                            </button>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>AMI ID</th>
                                    <th>Instance Type</th>
                                    <th>Security Groups</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="templates-table">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- New Credential Modal -->
<div class="modal fade" id="newCredentialModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add AWS Credentials</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newCredentialForm">
                    <div class="form-group">
                        <label for="credentialName">Name</label>
                        <input type="text" class="form-control" id="credentialName" required>
                    </div>
                    <div class="form-group">
                        <label for="accessKey">AWS Access Key</label>
                        <input type="text" class="form-control" id="accessKey" required>
                    </div>
                    <div class="form-group">
                        <label for="secretKey">AWS Secret Key</label>
                        <input type="password" class="form-control" id="secretKey" required>
                    </div>
                    <div class="form-group">
                        <label>Regions</label>
                        <div id="regionCheckboxes">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCredentials()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- New Region Modal -->
<div class="modal fade" id="newRegionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add AWS Region</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newRegionForm">
                    <div class="form-group">
                        <label for="regionName">Name</label>
                        <input type="text" class="form-control" id="regionName" required>
                    </div>
                    <div class="form-group">
                        <label for="regionCode">Code</label>
                        <input type="text" class="form-control" id="regionCode" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRegion()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- New Template Modal -->
<div class="modal fade" id="newTemplateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Jump Server Template</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newTemplateForm">
                    <div class="form-group">
                        <label for="templateName">Template Name</label>
                        <input type="text" class="form-control" id="templateName" required>
                    </div>
                    <div class="form-group">
                        <label for="amiId">AMI ID</label>
                        <input type="text" class="form-control" id="amiId" required>
                    </div>
                    <div class="form-group">
                        <label for="instanceType">Instance Type</label>
                        <select class="form-control" id="instanceType" required>
                            <option value="t2.micro">t2.micro</option>
                            <option value="t2.small">t2.small</option>
                            <option value="t2.medium">t2.medium</option>
                            <option value="t3.micro">t3.micro</option>
                            <option value="t3.small">t3.small</option>
                            <option value="t3.medium">t3.medium</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="securityGroups">Security Groups</label>
                        <input type="text" class="form-control" id="securityGroups" placeholder="sg-xxx, sg-yyy">
                        <small class="form-text text-muted">Comma-separated list of security group IDs</small>
                    </div>
                    <div class="form-group">
                        <label for="userData">User Data Script</label>
                        <textarea class="form-control" id="userData" rows="5"></textarea>
                        <small class="form-text text-muted">Bash script to run on instance launch</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showNewCredentialModal() {
    // Populate region checkboxes
    fetch('/api/regions')
        .then(response => response.json())
        .then(regions => {
            const container = document.getElementById('regionCheckboxes');
            container.innerHTML = regions.map(region => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${region.code}" id="region_${region.code}">
                    <label class="form-check-label" for="region_${region.code}">
                        ${region.name} (${region.code})
                    </label>
                </div>
            `).join('');
        });
    
    $('#newCredentialModal').modal('show');
}

function saveCredentials() {
    const form = document.getElementById('newCredentialForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Get selected regions
    const selectedRegions = Array.from(document.querySelectorAll('#regionCheckboxes input:checked'))
        .map(cb => cb.value);

    const data = {
        name: document.getElementById('credentialName').value,
        access_key: document.getElementById('accessKey').value,
        secret_key: document.getElementById('secretKey').value,
        regions: selectedRegions
    };

    fetch('{{ url_for("awsmon.manage_credentials") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            toastr.success('Credentials saved successfully');
            $('#newCredentialModal').modal('hide');
            updateCredentials();
        } else {
            toastr.error(data.message || 'Failed to save credentials');
        }
    })
    .catch(error => {
        toastr.error('Error saving credentials: ' + error);
    });
}

function showNewRegionModal() {
    $('#newRegionModal').modal('show');
}

function saveRegion() {
    const form = document.getElementById('newRegionForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        name: document.getElementById('regionName').value,
        code: document.getElementById('regionCode').value
    };

    fetch('{{ url_for("awsmon.manage_regions") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            toastr.success('Region added successfully');
            $('#newRegionModal').modal('hide');
            updateRegions();
        } else {
            toastr.error(data.message || 'Failed to add region');
        }
    })
    .catch(error => {
        toastr.error('Error adding region: ' + error);
    });
}

function showNewTemplateModal() {
    $('#newTemplateModal').modal('show');
}

function saveTemplate() {
    const form = document.getElementById('newTemplateForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        name: document.getElementById('templateName').value,
        ami_id: document.getElementById('amiId').value,
        instance_type: document.getElementById('instanceType').value,
        security_groups: document.getElementById('securityGroups').value.split(',').map(s => s.trim()),
        user_data: document.getElementById('userData').value
    };

    fetch('{{ url_for("awsmon.manage_templates") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            toastr.success('Template saved successfully');
            $('#newTemplateModal').modal('hide');
            updateTemplates();
        } else {
            toastr.error(data.message || 'Failed to save template');
        }
    })
    .catch(error => {
        toastr.error('Error saving template: ' + error);
    });
}

function updateCredentials() {
    fetch('{{ url_for("awsmon.manage_credentials") }}')
        .then(response => response.json())
        .then(credentials => {
            const tbody = document.getElementById('credentials-table');
            tbody.innerHTML = credentials.map(cred => `
                <tr>
                    <td>${cred.name}</td>
                    <td>${cred.vault_path}</td>
                    <td>${cred.regions.join(', ')}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="editCredentials(${cred.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCredentials(${cred.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        });
}

function updateRegions() {
    fetch('{{ url_for("awsmon.manage_regions") }}')
        .then(response => response.json())
        .then(regions => {
            const tbody = document.getElementById('regions-table');
            tbody.innerHTML = regions.map(region => `
                <tr>
                    <td>${region.name}</td>
                    <td>${region.code}</td>
                    <td>${region.instance_count}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="editRegion(${region.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRegion(${region.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        });
}

function updateTemplates() {
    fetch('{{ url_for("awsmon.manage_templates") }}')
        .then(response => response.json())
        .then(templates => {
            const tbody = document.getElementById('templates-table');
            tbody.innerHTML = templates.map(template => `
                <tr>
                    <td>${template.name}</td>
                    <td>${template.ami_id}</td>
                    <td>${template.instance_type}</td>
                    <td>${template.security_groups.join(', ')}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="launchInstance(${template.id})">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="editTemplate(${template.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${template.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        });
}

function editCredentials(id) {
    // Implement credential editing
}

function deleteCredentials(id) {
    if (confirm('Are you sure you want to delete these credentials?')) {
        // Implement credential deletion
    }
}

function editRegion(id) {
    // Implement region editing
}

function deleteRegion(id) {
    if (confirm('Are you sure you want to delete this region?')) {
        // Implement region deletion
    }
}

function editTemplate(id) {
    // Implement template editing
}

function deleteTemplate(id) {
    if (confirm('Are you sure you want to delete this template?')) {
        // Implement template deletion
    }
}

function launchInstance(templateId) {
    // Implement instance launch from template
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateCredentials();
    updateRegions();
    updateTemplates();
});
</script>
{% endblock %}
