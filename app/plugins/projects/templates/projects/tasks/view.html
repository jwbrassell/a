{% extends 'projects/layouts/_two_column.html' %}

{% block title %}{{ task.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.list_projects') }}">Projects</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.view_project', project_id=task.project.id) }}">{{ task.project.name }}</a></li>
<li class="breadcrumb-item active">{{ task.name }}</li>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
.form-control:disabled, 
.form-control[readonly],
.form-select:disabled {
    background-color: transparent;
    border: none;
    padding-left: 0;
    cursor: default;
}
.input-group-text {
    background-color: transparent;
    border: none;
}
textarea.form-control[readonly] {
    min-height: unset;
    height: auto;
}
.todo-list {
    min-height: unset;
}
.todo-item {
    padding: 8px;
    margin: 4px 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.history-table th {
    background: #f8f9fa;
}
.direct-chat-messages {
    height: 400px;
    overflow-y: auto;
}
.direct-chat-text {
    margin: 5px 0 0 10px;
}
/* Rich text content styling */
.rich-text-content {
    line-height: 1.6;
}
.rich-text-content p {
    margin-bottom: 1rem;
}
.rich-text-content ul, 
.rich-text-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}
.rich-text-content img {
    max-width: 100%;
    height: auto;
}
.rich-text-content table {
    width: 100%;
    margin-bottom: 1rem;
    border-collapse: collapse;
}
.rich-text-content table td,
.rich-text-content table th {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
}
/* DataTables customization */
.dataTables_wrapper .dataTables_length select {
    padding-right: 25px;
}
.dataTables_wrapper .dataTables_filter input {
    margin-left: 5px;
}
.dataTables_wrapper .dataTables_info {
    padding-top: 0.5em;
}
.dataTables_wrapper .dataTables_paginate {
    padding-top: 0.5em;
}
</style>
{% endblock %}

{% block left_column %}
    <!-- Task Details -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">
                <i class="fas fa-tasks me-1"></i>
                Task Details
            </h3>
        </div>
        <div class="card-body">
            <!-- Name -->
            <div class="form-group mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" value="{{ task.name }}" readonly>
            </div>

            <!-- Summary -->
            <div class="form-group mb-3">
                <label class="form-label">Summary</label>
                <input type="text" class="form-control" value="{{ task.summary }}" readonly>
            </div>

            <!-- Description -->
            <div class="form-group mb-3">
                <label class="form-label">Description</label>
                <div class="rich-text-content">
                    {{ task.description|safe }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sub Tasks -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#subTasksCollapse" aria-expanded="true" aria-controls="subTasksCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-tasks me-1"></i>
                    Sub Tasks
                </h3>
                <i class="fas fa-minus collapse-icon"></i>
            </div>
        </div>
        <div class="collapse show" id="subTasksCollapse">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="subTasksTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Summary</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Lead</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subtask in task.subtasks %}
                            <tr>
                                <td>{{ subtask.name }}</td>
                                <td>{{ subtask.summary }}</td>
                                <td><span class="badge bg-{{ subtask.status.color if subtask.status else 'secondary' }}">{{ subtask.status.name if subtask.status else 'Not Set' }}</span></td>
                                <td><span class="badge bg-{{ subtask.priority.color if subtask.priority else 'secondary' }}">{{ subtask.priority.name if subtask.priority else 'Not Set' }}</span></td>
                                <td>{{ subtask.assigned_to.username if subtask.assigned_to else 'Unassigned' }}</td>
                                <td>{{ subtask.due_date|date if subtask.due_date else 'Not Set' }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-info view-subtask" data-subtask-id="{{ subtask.id }}" title="View Sub Task">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if can_edit %}
                                        <button type="button" class="btn btn-sm btn-primary edit-subtask" data-subtask-id="{{ subtask.id }}" title="Edit Sub Task">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger delete-subtask" data-subtask-id="{{ subtask.id }}" title="Delete Sub Task">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if can_edit %}
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-primary" id="createSubTaskBtn">
                        <i class="fas fa-plus me-1"></i> Create Sub Task
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Todo List -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#todosCollapse" aria-expanded="true" aria-controls="todosCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-check-square me-1"></i>
                    Todo List
                </h3>
                <i class="fas fa-minus todos-collapse-icon"></i>
            </div>
        </div>
        <div class="collapse show" id="todosCollapse">
            <div class="card-body p-0">
                {% with readonly=True %}
                {% include 'projects/todos/_list.html' %}
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#commentsCollapse" aria-expanded="false" aria-controls="commentsCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-comments me-1"></i>
                    Comments
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="commentsCollapse">
            <div class="card-body">
                {% include 'projects/comments/_list.html' %}
            </div>
        </div>
    </div>

    <!-- History Table -->
    <div class="card">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-history me-1"></i>
                    Task History
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="historyCollapse">
            <div class="card-body">
                {% include 'projects/history/_list.html' %}
            </div>
        </div>
    </div>

    <!-- Include Sub Task Modal -->
    {% include 'projects/tasks/_subtask_modal.html' %}
{% endblock %}

{% block right_column %}
    <!-- Task Info -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">
                <i class="fas fa-info-circle me-1"></i>
                Task Information
            </h3>
        </div>
        <div class="card-body">
            <!-- Status -->
            <div class="form-group mb-3">
                <label class="form-label">Status</label>
                <div>
                    <span class="badge bg-{{ task.status.color if task.status else 'secondary' }}">
                        {{ task.status.name if task.status else 'Not Set' }}
                    </span>
                </div>
            </div>

            <!-- Priority -->
            <div class="form-group mb-3">
                <label class="form-label">Priority</label>
                <div>
                    <span class="badge bg-{{ task.priority.color if task.priority else 'secondary' }}">
                        {{ task.priority.name if task.priority else 'Not Set' }}
                    </span>
                </div>
            </div>

            <!-- Lead -->
            <div class="form-group mb-3">
                <label class="form-label">Lead</label>
                <div>
                    {% if task.assigned_to %}
                    <img src="{{ url_for('static', filename=task.assigned_to.get_preference('avatar', 'images/user_1.jpg')) }}" 
                         class="img-circle elevation-1" 
                         alt="Lead Avatar" 
                         style="width: 30px; height: 30px;">
                    {{ task.assigned_to.username }}
                    {% else %}
                    <span class="text-muted">Unassigned</span>
                    {% endif %}
                </div>
            </div>

            <!-- Created -->
            <div class="form-group mb-3">
                <label class="form-label">Created</label>
                <div>{{ task.created_at|datetime }}</div>
            </div>

            <!-- Last Updated -->
            <div class="form-group mb-3">
                <label class="form-label">Last Updated</label>
                <div>{{ task.updated_at|datetime }}</div>
            </div>
        </div>
    </div>

    {% if can_edit %}
    <a href="{{ url_for('projects.edit_task', task_id=task.id) }}" class="btn btn-primary btn-lg w-100 mb-4">
        <i class="fas fa-edit me-1"></i> Edit Task
    </a>
    {% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('projects.static', filename='js/comments.js') }}"></script>
<script src="{{ url_for('projects.static', filename='js/subtasks.js') }}"></script>
<script>
(function() {
    'use strict';
    
    // Task variables
    var taskModule = {
        taskId: "{{ task.id }}",
        currentUserId: "{{ current_user.id }}"
    };
    window.taskModule = taskModule;

    // Initialize DataTable for sub tasks
    $(document).ready(function() {
        const subTasksTable = $('#subTasksTable').DataTable({
            pageLength: 10,
            order: [[0, 'asc']],
            columnDefs: [
                { orderable: false, targets: -1 } // Disable sorting on actions column
            ]
        });

        // Handle sub task modal events using event delegation
        $('#subTasksTable').on('click', '.view-subtask', function() {
            const subtaskId = $(this).data('subtask-id');
            loadSubTask(subtaskId, true);
        });

        $('#subTasksTable').on('click', '.edit-subtask', function() {
            const subtaskId = $(this).data('subtask-id');
            loadSubTask(subtaskId, false);
        });

        $('#subTasksTable').on('click', '.delete-subtask', function() {
            const subtaskId = $(this).data('subtask-id');
            if (confirm('Are you sure you want to delete this sub task?')) {
                deleteSubTask(subtaskId);
            }
        });

        // Handle create button
        $('#createSubTaskBtn').on('click', function() {
            $('#subtaskModal').modal('show');
            $('#modalTitle').text('Create Sub Task');
            $('#subtaskForm')[0].reset();
            $('.created-at-field, .updated-at-field').hide();
        });
    });

    // Handle collapse icon changes
    document.addEventListener('DOMContentLoaded', function() {
        // Sub Tasks collapse functionality
        const subTasksCollapse = document.getElementById('subTasksCollapse');
        const subTasksCollapseIcon = subTasksCollapse.previousElementSibling.querySelector('.collapse-icon');
        
        subTasksCollapse.addEventListener('show.bs.collapse', function() {
            subTasksCollapseIcon.classList.remove('fa-plus');
            subTasksCollapseIcon.classList.add('fa-minus');
        });
        
        subTasksCollapse.addEventListener('hide.bs.collapse', function() {
            subTasksCollapseIcon.classList.remove('fa-minus');
            subTasksCollapseIcon.classList.add('fa-plus');
        });

        // Todos collapse functionality
        const todosCollapse = document.getElementById('todosCollapse');
        const todosCollapseIcon = todosCollapse.previousElementSibling.querySelector('.todos-collapse-icon');
        
        todosCollapse.addEventListener('show.bs.collapse', function() {
            todosCollapseIcon.classList.remove('fa-plus');
            todosCollapseIcon.classList.add('fa-minus');
        });
        
        todosCollapse.addEventListener('hide.bs.collapse', function() {
            todosCollapseIcon.classList.remove('fa-minus');
            todosCollapseIcon.classList.add('fa-plus');
        });

        // Comments collapse functionality
        const commentsCollapse = document.getElementById('commentsCollapse');
        const commentsCollapseIcon = commentsCollapse.previousElementSibling.querySelector('.fa-plus');
        
        commentsCollapse.addEventListener('show.bs.collapse', function() {
            commentsCollapseIcon.classList.remove('fa-plus');
            commentsCollapseIcon.classList.add('fa-minus');
        });
        
        commentsCollapse.addEventListener('hide.bs.collapse', function() {
            commentsCollapseIcon.classList.remove('fa-minus');
            commentsCollapseIcon.classList.add('fa-plus');
        });
    });
})();
</script>
{% endblock %}
