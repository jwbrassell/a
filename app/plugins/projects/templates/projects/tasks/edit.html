{% extends 'projects/layouts/_two_column.html' %}

{% block title %}Edit {{ task.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.list_projects') }}">Projects</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.view_project', project_id=task.project.id) }}">{{ task.project.name }}</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.view_task', task_id=task.id) }}">{{ task.name }}</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
.todo-list {
    min-height: unset;
}
.todo-item {
    padding: 8px;
    margin: 4px 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.history-table th {
    background: #f8f9fa;
}
.direct-chat-messages {
    height: 400px;
    overflow-y: auto;
}
.direct-chat-text {
    margin: 5px 0 0 10px;
}
/* DataTables customization */
.dataTables_wrapper .dataTables_length select {
    padding-right: 25px;
}
.dataTables_wrapper .dataTables_filter input {
    margin-left: 5px;
}
.dataTables_wrapper .dataTables_info {
    padding-top: 0.5em;
}
.dataTables_wrapper .dataTables_paginate {
    padding-top: 0.5em;
}
</style>
{% endblock %}

{% block left_column %}
<form id="taskForm" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- Task Details -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">
                <i class="fas fa-tasks me-1"></i>
                Task Details
            </h3>
        </div>
        <div class="card-body">
            <!-- Name -->
            <div class="form-group mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" name="name" value="{{ task.name }}" required>
            </div>

            <!-- Summary -->
            <div class="form-group mb-3">
                <label class="form-label">Summary</label>
                <input type="text" class="form-control" name="summary" value="{{ task.summary }}">
            </div>

            <!-- Description -->
            <div class="form-group mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="5">{{ task.description }}</textarea>
            </div>
        </div>
    </div>

    <!-- Sub Tasks -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#subTasksCollapse" aria-expanded="true" aria-controls="subTasksCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-tasks me-1"></i>
                    Sub Tasks
                </h3>
                <i class="fas fa-minus collapse-icon"></i>
            </div>
        </div>
        <div class="collapse show" id="subTasksCollapse">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="subTasksTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Summary</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Lead</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subtask in task.subtasks %}
                            <tr>
                                <td>{{ subtask.name }}</td>
                                <td>{{ subtask.summary }}</td>
                                <td><span class="badge bg-{{ subtask.status.color if subtask.status else 'secondary' }}">{{ subtask.status.name if subtask.status else 'Not Set' }}</span></td>
                                <td><span class="badge bg-{{ subtask.priority.color if subtask.priority else 'secondary' }}">{{ subtask.priority.name if subtask.priority else 'Not Set' }}</span></td>
                                <td>{{ subtask.assigned_to.username if subtask.assigned_to else 'Unassigned' }}</td>
                                <td>{{ subtask.due_date|date if subtask.due_date else 'Not Set' }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-info view-subtask" data-subtask-id="{{ subtask.id }}" title="View Sub Task">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-primary edit-subtask" data-subtask-id="{{ subtask.id }}" title="Edit Sub Task">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger delete-subtask" data-subtask-id="{{ subtask.id }}" title="Delete Sub Task">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-primary" id="createSubTaskBtn">
                        <i class="fas fa-plus me-1"></i> Add Sub Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Todo List -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#todosCollapse" aria-expanded="true" aria-controls="todosCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-check-square me-1"></i>
                    Todo List
                </h3>
                <i class="fas fa-minus todos-collapse-icon"></i>
            </div>
        </div>
        <div class="collapse show" id="todosCollapse">
            <div class="card-body p-0">
                {% include 'projects/todos/_list.html' %}
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#commentsCollapse" aria-expanded="false" aria-controls="commentsCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-comments me-1"></i>
                    Comments
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="commentsCollapse">
            <div class="card-body">
                {% include 'projects/comments/_list.html' %}
            </div>
        </div>
    </div>

    <!-- History Table -->
    <div class="card">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-history me-1"></i>
                    Task History
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="historyCollapse">
            <div class="card-body">
                {% include 'projects/history/_list.html' %}
            </div>
        </div>
    </div>

    <!-- Include Sub Task Modal -->
    {% include 'projects/tasks/_subtask_modal.html' %}
</form>
{% endblock %}

{% block right_column %}
    <!-- Task Info -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">
                <i class="fas fa-info-circle me-1"></i>
                Task Information
            </h3>
        </div>
        <div class="card-body">
            <!-- Status -->
            <div class="form-group mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" name="status" form="taskForm">
                    {% for status in statuses %}
                    <option value="{{ status.name }}" data-color="{{ status.color }}" {% if task.status and task.status.name == status.name %}selected{% endif %}>
                        {{ status.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Priority -->
            <div class="form-group mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" name="priority" form="taskForm">
                    {% for priority in priorities %}
                    <option value="{{ priority.name }}" data-color="{{ priority.color }}" {% if task.priority and task.priority.name == priority.name %}selected{% endif %}>
                        {{ priority.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Lead -->
            <div class="form-group mb-3">
                <label class="form-label">Lead</label>
                <select class="form-select" name="assigned_to_id" form="taskForm">
                    <option value="">Unassigned</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if task.assigned_to_id == user.id %}selected{% endif %}>
                        {{ user.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Created -->
            <div class="form-group mb-3">
                <label class="form-label">Created</label>
                <div>{{ task.created_at|datetime }}</div>
            </div>

            <!-- Last Updated -->
            <div class="form-group mb-3">
                <label class="form-label">Last Updated</label>
                <div>{{ task.updated_at|datetime }}</div>
            </div>
        </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" form="taskForm" class="btn btn-primary btn-lg w-100 mb-4">
        <i class="fas fa-save me-1"></i> Save Changes
    </button>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('projects.static', filename='js/comments.js') }}"></script>
<script src="{{ url_for('projects.static', filename='js/tasks.js') }}"></script>
<script src="{{ url_for('projects.static', filename='js/subtasks.js') }}"></script>
<script>
(function() {
    'use strict';
    
    // Task variables
    var taskModule = {
        taskId: "{{ task.id }}",
        currentUserId: "{{ current_user.id }}"
    };
    window.taskModule = taskModule;

    // Initialize DataTable for sub tasks
    $(document).ready(function() {
        const subTasksTable = $('#subTasksTable').DataTable({
            pageLength: 10,
            order: [[0, 'asc']],
            columnDefs: [
                { orderable: false, targets: -1 } // Disable sorting on actions column
            ]
        });

        // Handle sub task modal events using event delegation
        $('#subTasksTable').on('click', '.view-subtask', function() {
            const subtaskId = $(this).data('subtask-id');
            loadSubTask(subtaskId, true);
        });

        $('#subTasksTable').on('click', '.edit-subtask', function() {
            const subtaskId = $(this).data('subtask-id');
            loadSubTask(subtaskId, false);
        });

        $('#subTasksTable').on('click', '.delete-subtask', function() {
            const subtaskId = $(this).data('subtask-id');
            if (confirm('Are you sure you want to delete this sub task?')) {
                deleteSubTask(subtaskId);
            }
        });

        // Handle create button
        $('#createSubTaskBtn').on('click', function() {
            $('#subtaskModal').modal('show');
            $('#modalTitle').text('Create Sub Task');
            $('#subtaskForm')[0].reset();
            $('.created-at-field, .updated-at-field').hide();
        });
    });

    // Handle collapse icon changes
    document.addEventListener('DOMContentLoaded', function() {
        // Sub Tasks collapse functionality
        const subTasksCollapse = document.getElementById('subTasksCollapse');
        const subTasksCollapseIcon = subTasksCollapse.previousElementSibling.querySelector('.collapse-icon');
        
        subTasksCollapse.addEventListener('show.bs.collapse', function() {
            subTasksCollapseIcon.classList.remove('fa-plus');
            subTasksCollapseIcon.classList.add('fa-minus');
        });
        
        subTasksCollapse.addEventListener('hide.bs.collapse', function() {
            subTasksCollapseIcon.classList.remove('fa-minus');
            subTasksCollapseIcon.classList.add('fa-plus');
        });

        // Todos collapse functionality
        const todosCollapse = document.getElementById('todosCollapse');
        const todosCollapseIcon = todosCollapse.previousElementSibling.querySelector('.todos-collapse-icon');
        
        todosCollapse.addEventListener('show.bs.collapse', function() {
            todosCollapseIcon.classList.remove('fa-plus');
            todosCollapseIcon.classList.add('fa-minus');
        });
        
        todosCollapse.addEventListener('hide.bs.collapse', function() {
            todosCollapseIcon.classList.remove('fa-minus');
            todosCollapseIcon.classList.add('fa-plus');
        });

        // Comments collapse functionality
        const commentsCollapse = document.getElementById('commentsCollapse');
        const commentsCollapseIcon = commentsCollapse.previousElementSibling.querySelector('.fa-plus');
        
        commentsCollapse.addEventListener('show.bs.collapse', function() {
            commentsCollapseIcon.classList.remove('fa-plus');
            commentsCollapseIcon.classList.add('fa-minus');
        });
        
        commentsCollapse.addEventListener('hide.bs.collapse', function() {
            commentsCollapseIcon.classList.remove('fa-minus');
            commentsCollapseIcon.classList.add('fa-plus');
        });
    });
})();
</script>
{% endblock %}
