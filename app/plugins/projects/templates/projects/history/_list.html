<div class="timeline">
  {% set current_date = None %}
  {% set history_entries = task.project.history if task is defined else project.history %}
  {% for entry in history_entries|sort(attribute='created_at', reverse=True) %}
    {% if current_date != entry.created_at.date() %}
      {% set current_date = entry.created_at.date() %}
      <div class="time-label">
        <span class="bg-primary rounded px-3 py-1">
          {{ entry.created_at.strftime('%d %b. %Y') }}
        </span>
      </div>
    {% endif %}
    
    <div class="timeline-item">
      <div class="timeline-item-marker">
        <div class="timeline-item-marker-indicator bg-light">
          {% if entry.entity_type == 'task' %}
            <i class="fas fa-tasks text-primary"></i>
          {% elif entry.entity_type == 'todo' %}
            <i class="fas fa-check-square text-success"></i>
          {% elif entry.entity_type == 'comment' %}
            <i class="fas fa-comment text-info"></i>
          {% else %}
            <i class="fas fa-history text-secondary"></i>
          {% endif %}
        </div>
      </div>
      <div class="timeline-item-content pt-0">
        <div class="card shadow-sm">
          <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center">
              {% if entry.user %}
                <img src="{{ url_for('profile.get_avatar', user_id=entry.user.id) }}" class="rounded-circle me-2" style="width: 24px; height: 24px; object-fit: cover;">
                <span class="text-primary">{{ entry.user.username }}</span>
              {% endif %}
              <span class="ms-2">
                {% if entry.action == 'created' %}
                  created a new {{ entry.entity_type }}
                {% elif entry.action == 'updated' %}
                  updated {{ entry.entity_type }}
                {% elif entry.action == 'deleted' %}
                  deleted {{ entry.entity_type }}
                {% elif entry.action == 'completed' %}
                  completed {{ entry.entity_type }}
                {% else %}
                  {{ entry.action }} {{ entry.entity_type }}
                {% endif %}
              </span>
            </div>
            <small class="text-muted">
              <i class="far fa-clock me-1"></i>
              {{ entry.created_at.strftime('%I:%M %p') }}
            </small>
          </div>
          {% if entry.details %}
          <div class="card-body py-2">
            {% if entry.action == 'created' %}
              <div class="text-muted">
                {% if entry.details.name %}
                  <strong>Name:</strong> {{ entry.details.name }}<br>
                {% endif %}
                {% if entry.details.description %}
                  <strong>Description:</strong> {{ entry.details.description|truncate(100) }}
                {% endif %}
              </div>
            {% elif entry.action == 'updated' %}
              <div class="text-muted">
                {% for field, changes in entry.details.items() %}
                  <div class="mb-1">
                    <strong>{{ field|title }}:</strong>
                    {% if changes is mapping %}
                      <span class="text-danger"><s>{{ changes.old }}</s></span> â†’
                      <span class="text-success">{{ changes.new }}</span>
                    {% else %}
                      {{ changes }}
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted">
                {% for key, value in entry.details.items() %}
                  <strong>{{ key|title }}:</strong> {{ value }}<br>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
  
  <div class="timeline-end">
    <div class="timeline-end-marker">
      <i class="far fa-clock text-muted"></i>
    </div>
  </div>
</div>

<style>
.timeline {
  position: relative;
  padding: 1rem 0;
}

.timeline::before {
  content: '';
  position: absolute;
  top: 0;
  left: 1rem;
  height: 100%;
  border-left: 2px solid var(--bs-border-color);
}

.time-label {
  position: relative;
  margin-bottom: 1rem;
  margin-left: 1.5rem;
}

.timeline-item {
  position: relative;
  margin-bottom: 1.5rem;
  margin-left: 1.5rem;
}

.timeline-item-marker {
  position: absolute;
  left: -2.45rem;
  width: 1rem;
  height: 1rem;
  margin-top: 0.75rem;
}

.timeline-item-marker-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  border-radius: 100%;
  border: 2px solid var(--bs-border-color);
  margin-left: -0.5rem;
  margin-top: -0.5rem;
}

.timeline-item-marker-indicator i {
  font-size: 0.875rem;
}

.timeline-item-content {
  padding-top: 0.25rem;
  padding-left: 1rem;
}

.timeline-end {
  position: relative;
  margin-left: 1.5rem;
}

.timeline-end-marker {
  position: absolute;
  left: -2.45rem;
  width: 1rem;
  height: 1rem;
  margin-top: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  border-radius: 100%;
  border: 2px solid var(--bs-border-color);
  margin-left: -0.5rem;
  margin-top: -0.5rem;
  background-color: var(--bs-body-bg);
}

.timeline-end-marker i {
  font-size: 0.875rem;
}

/* Dark mode support */
[data-bs-theme="dark"] .timeline::before {
  border-left-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .timeline-item-marker-indicator {
  border-color: var(--bs-border-color);
  background-color: var(--bs-dark);
}

[data-bs-theme="dark"] .timeline-end-marker {
  border-color: var(--bs-border-color);
  background-color: var(--bs-dark);
}

[data-bs-theme="dark"] .card-header {
  background-color: var(--bs-tertiary-bg) !important;
}
</style>
