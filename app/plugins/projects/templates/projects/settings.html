{% extends 'base.html' %}

<!-- Previous HTML content remains unchanged until scripts block -->

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap4',
        width: '100%'
    });

    // Initialize description editor
    $('#description').summernote({
        height: 150,
        toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['font', ['strikethrough']],
            ['para', ['ul', 'ol']],
            ['insert', ['link']],
            ['view', ['fullscreen', 'codeview']]
        ]
    });

    // Project Details Form
    $('#project-details-form').submit(function(e) {
        e.preventDefault();
        const formData = {
            name: $('#name').val(),
            description: $('#description').summernote('code'),
            status: $('#status').val()
        };

        $.ajax({
            url: "{{ url_for('projects.settings', project_id=project.id) }}",
            method: 'POST',
            data: {
                ...formData,
                form_type: 'details'
            },
            success: function(response) {
                if (response.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Project details updated successfully',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error updating project details',
                        text: response.message
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to update project details. Please try again.'
                });
            }
        });
    });

    // Project Roles Form
    $('#project-roles-form').submit(function(e) {
        e.preventDefault();
        const formData = {
            lead_id: $('#lead').val(),
            team_members: $('#team_members').val(),
            watchers: $('#watchers').val(),
            stakeholders: $('#stakeholders').val(),
            shareholders: $('#shareholders').val()
        };

        $.ajax({
            url: "{{ url_for('projects.settings', project_id=project.id) }}",
            method: 'POST',
            data: {
                ...formData,
                form_type: 'roles'
            },
            success: function(response) {
                if (response.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Project roles updated successfully',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error updating project roles',
                        text: response.message
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to update project roles. Please try again.'
                });
            }
        });
    });

    // Notification Settings Form
    $('#notification-settings-form').submit(function(e) {
        e.preventDefault();
        const formData = {
            notify_task_created: $('#notify_task_created').is(':checked'),
            notify_task_completed: $('#notify_task_completed').is(':checked'),
            notify_comments: $('#notify_comments').is(':checked')
        };

        $.ajax({
            url: "{{ url_for('projects.settings', project_id=project.id) }}",
            method: 'POST',
            data: {
                ...formData,
                form_type: 'notifications'
            },
            success: function(response) {
                if (response.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Notification settings updated successfully',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error updating notification settings',
                        text: response.message
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to update notification settings. Please try again.'
                });
            }
        });
    });

    // Handle flash messages
    const flashMessages = JSON.parse($('#flash-messages').attr('data-messages') || '[]');
    flashMessages.forEach(function(message) {
        const [category, text] = message;
        Swal.fire({
            icon: category === 'success' ? 'success' : 'error',
            title: text,
            showConfirmButton: false,
            timer: 3000
        });
    });
});

// Danger zone functions
function archiveProject() {
    Swal.fire({
        title: 'Archive Project?',
        text: 'Are you sure you want to archive this project?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, archive it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "{{ url_for('projects.archive_project', project_id=project.id) }}",
                method: 'POST',
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Project archived successfully',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(function() {
                        window.location.href = "{{ url_for('projects.index') }}";
                    });
                },
                error: function(xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to archive project. Please try again.'
                    });
                }
            });
        }
    });
}

function deleteProject() {
    Swal.fire({
        title: 'Delete Project?',
        text: 'This action cannot be undone!',
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "{{ url_for('projects.delete_project', project_id=project.id) }}",
                method: 'POST',
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Project deleted successfully',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(function() {
                        window.location.href = "{{ url_for('projects.index') }}";
                    });
                },
                error: function(xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to delete project. Please try again.'
                    });
                }
            });
        }
    });
}
</script>
{% endblock %}
