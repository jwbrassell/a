<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="card-title mb-0">
    <i class="fas fa-comments me-1"></i>
    Comments
  </h3>
  {% if project.unread_comments %}
  <span class="badge bg-primary">{{ project.unread_comments }} new</span>
  {% endif %}
</div>

<div class="direct-chat-messages">
  {% for comment in project.comments %}
  <div class="direct-chat-msg {% if comment.user_id == current_user.id %}right{% endif %}" id="comment-{{ comment.id }}">
    <div class="direct-chat-infos clearfix">
      <span class="direct-chat-name float-{% if comment.user_id == current_user.id %}end{% else %}start{% endif %}">
        {{ comment.user.name }}
      </span>
      <span class="direct-chat-timestamp float-{% if comment.user_id == current_user.id %}start{% else %}end{% endif %}">
        {{ comment.created_at.strftime('%d %b %I:%M %p') }}
      </span>
    </div>
    <img class="direct-chat-img" src="{{ comment.user.avatar_url }}" alt="message user image">
    <div class="direct-chat-text rich-text-content">
      {{ comment.content|safe }}
    </div>
    {% if comment.user_id == current_user.id %}
    <div class="direct-chat-actions">
      <button class="btn btn-sm btn-link" onclick="editComment({{ comment.id }})">
        <i class="fas fa-edit"></i>
      </button>
      <button class="btn btn-sm btn-link text-danger" onclick="deleteComment({{ comment.id }})">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<form id="comment-form" onsubmit="submitComment(event)" class="mt-3">
  <div class="mb-3">
    <textarea id="comment-message" class="form-control rich-text-editor" 
              rows="3" placeholder="Type your comment..." required></textarea>
  </div>
  <div class="text-end">
    <button type="submit" class="btn btn-primary">
      <i class="fas fa-paper-plane me-1"></i> Send Comment
    </button>
  </div>
</form>

<!-- Include comments.js -->
<script src="{{ url_for('projects.static', filename='js/comments.js') }}"></script>

<style>
.direct-chat-messages {
    height: 400px;
    padding: 10px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.direct-chat-msg {
    margin-bottom: 1rem;
}

.direct-chat-msg.right .direct-chat-text {
    margin-right: 50px;
    margin-left: 0;
    background-color: #007bff;
    color: #fff;
}

.direct-chat-text {
    border-radius: 0.5rem;
    background-color: #fff;
    border: 1px solid #dee2e6;
    padding: 0.5rem 1rem;
    margin-left: 50px;
    margin-right: 0;
    position: relative;
}

.direct-chat-text.rich-text-content img {
    max-width: 100%;
    height: auto;
}

.direct-chat-text.rich-text-content p:last-child {
    margin-bottom: 0;
}

.direct-chat-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    float: left;
}

.right .direct-chat-img {
    float: right;
}

.direct-chat-infos {
    margin-bottom: 0.25rem;
}

.direct-chat-name {
    font-weight: 600;
    font-size: 0.875rem;
}

.direct-chat-timestamp {
    color: #6c757d;
    font-size: 0.75rem;
}

.direct-chat-actions {
    margin-top: 0.25rem;
    text-align: right;
}

.direct-chat-actions .btn-link {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* TinyMCE customizations for comments */
.tox-tinymce {
    border-radius: 0.375rem;
}

.direct-chat-msg.right .direct-chat-text.rich-text-content {
    color: #fff;
}

.direct-chat-msg.right .direct-chat-text.rich-text-content a {
    color: #fff;
    text-decoration: underline;
}
</style>
