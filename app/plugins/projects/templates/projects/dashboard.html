{% extends 'base.html' %}

{% block title %}Projects Dashboard{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('projects.index') }}">Projects</a></li>
    <li class="breadcrumb-item active">Dashboard</li>
</ol>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-6">
            <h1 class="m-0">Projects Dashboard</h1>
        </div>
        <div class="col-6 text-right">
            <a href="{{ url_for('projects.list_projects') }}" class="btn btn-info mr-2">
                <i class="fas fa-list"></i> View Projects
            </a>
            <a href="{{ url_for('projects.new_project') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create Project
            </a>
        </div>
    </div>

    <!-- Rest of the dashboard content remains the same -->
    <!-- Project Statistics -->
    <div class="row">
        <!-- Project Status Distribution -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Project Status Distribution</h3>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Project Priority Distribution -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Priority Distribution</h3>
                </div>
                <div class="card-body">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Management -->
    <div class="row mt-4">
        <!-- Status Management -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Status Management</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-primary btn-sm" onclick="addStatus()">
                            <i class="fas fa-plus"></i> Add Status
                        </button>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Color</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="statusTable">
                            {% for status in statuses %}
                            <tr>
                                <td>{{ status.name }}</td>
                                <td>
                                    <span class="badge badge-{{ status.color }}">{{ status.name }}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editStatus('{{ status.name }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteStatus('{{ status.name }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Priority Management -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Priority Management</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-primary btn-sm" onclick="addPriority()">
                            <i class="fas fa-plus"></i> Add Priority
                        </button>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Color</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="priorityTable">
                            {% for priority in priorities %}
                            <tr>
                                <td>{{ priority.name }}</td>
                                <td>
                                    <span class="badge badge-{{ priority.color }}">{{ priority.name }}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editPriority('{{ priority.name }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePriority('{{ priority.name }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Assignment Overview -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Team Assignment Overview</h3>
                </div>
                <div class="card-body">
                    <canvas id="teamAssignmentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Status</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-group">
                        <label>Status Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <select class="form-control" name="color">
                            <option value="primary">Blue</option>
                            <option value="success">Green</option>
                            <option value="warning">Yellow</option>
                            <option value="danger">Red</option>
                            <option value="info">Light Blue</option>
                            <option value="secondary">Gray</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatus()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Priority Modal -->
<div class="modal fade" id="priorityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Priority</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="priorityForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-group">
                        <label>Priority Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <select class="form-control" name="color">
                            <option value="success">Green</option>
                            <option value="warning">Yellow</option>
                            <option value="danger">Red</option>
                            <option value="info">Light Blue</option>
                            <option value="secondary">Gray</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePriority()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Get data from server-side
const statusLabels = {{ status_labels | tojson | safe }};
const statusData = {{ status_data | tojson | safe }};
const priorityLabels = {{ priority_labels | tojson | safe }};
const priorityData = {{ priority_data | tojson | safe }};
const teamLabels = {{ team_labels | tojson | safe }};
const teamData = {{ team_data | tojson | safe }};

// Chart configurations
const statusChartConfig = {
    type: 'pie',
    data: {
        labels: statusLabels,
        datasets: [{
            data: statusData,
            backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right'
            }
        }
    }
};

const priorityChartConfig = {
    type: 'pie',
    data: {
        labels: priorityLabels,
        datasets: [{
            data: priorityData,
            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right'
            }
        }
    }
};

const teamAssignmentConfig = {
    type: 'bar',
    data: {
        labels: teamLabels,
        datasets: [{
            label: 'Assigned Tasks',
            data: teamData,
            backgroundColor: '#007bff'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
};

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    new Chart(document.getElementById('statusChart'), statusChartConfig);
    new Chart(document.getElementById('priorityChart'), priorityChartConfig);
    new Chart(document.getElementById('teamAssignmentChart'), teamAssignmentConfig);
});

// Status Management
function addStatus() {
    $('#statusForm')[0].reset();
    $('#statusModal').modal('show');
}

function editStatus(name) {
    $.get(`{{ url_for('projects.get_status') }}?name=${name}`, function(data) {
        $('#statusForm input[name="name"]').val(data.name);
        $('#statusForm select[name="color"]').val(data.color);
        $('#statusModal').modal('show');
    });
}

function saveStatus() {
    const formData = new FormData($('#statusForm')[0]);
    $.ajax({
        url: "{{ url_for('projects.save_status') }}",
        method: 'POST',
        data: Object.fromEntries(formData),
        headers: {
            'X-CSRFToken': formData.get('csrf_token')
        },
        success: function(response) {
            if (response.status === 'success') {
                $('#statusModal').modal('hide');
                location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.message
                });
            }
        }
    });
}

function deleteStatus(name) {
    Swal.fire({
        title: 'Delete Status?',
        text: 'This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: 'Delete'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "{{ url_for('projects.delete_status') }}",
                method: 'POST',
                data: { 
                    name: name,
                    csrf_token: "{{ csrf_token() }}"
                },
                headers: {
                    'X-CSRFToken': "{{ csrf_token() }}"
                },
                success: function(response) {
                    if (response.status === 'success') {
                        location.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message
                        });
                    }
                }
            });
        }
    });
}

// Priority Management
function addPriority() {
    $('#priorityForm')[0].reset();
    $('#priorityModal').modal('show');
}

function editPriority(name) {
    $.get(`{{ url_for('projects.get_priority') }}?name=${name}`, function(data) {
        $('#priorityForm input[name="name"]').val(data.name);
        $('#priorityForm select[name="color"]').val(data.color);
        $('#priorityModal').modal('show');
    });
}

function savePriority() {
    const formData = new FormData($('#priorityForm')[0]);
    $.ajax({
        url: "{{ url_for('projects.save_priority') }}",
        method: 'POST',
        data: Object.fromEntries(formData),
        headers: {
            'X-CSRFToken': formData.get('csrf_token')
        },
        success: function(response) {
            if (response.status === 'success') {
                $('#priorityModal').modal('hide');
                location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.message
                });
            }
        }
    });
}

function deletePriority(name) {
    Swal.fire({
        title: 'Delete Priority?',
        text: 'This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: 'Delete'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "{{ url_for('projects.delete_priority') }}",
                method: 'POST',
                data: { 
                    name: name,
                    csrf_token: "{{ csrf_token() }}"
                },
                headers: {
                    'X-CSRFToken': "{{ csrf_token() }}"
                },
                success: function(response) {
                    if (response.status === 'success') {
                        location.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message
                        });
                    }
                }
            });
        }
    });
}
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
.card {
    margin-bottom: 1rem;
}
.badge {
    font-size: 100%;
}
</style>
{% endblock %}
