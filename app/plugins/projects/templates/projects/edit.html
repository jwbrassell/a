{% extends 'base.html' %}

{% block title %}{{ project.name }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
.todo-list {
    min-height: 100px;
}
.todo-item {
    padding: 8px;
    margin: 4px 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.todo-item:hover {
    background: #f8f9fa;
}
.todo-content {
    flex-grow: 1;
    margin: 0 8px;
}
.history-table th {
    background: #f8f9fa;
}
.direct-chat-messages {
    height: 400px;
    overflow-y: auto;
}
.direct-chat-text {
    margin: 5px 0 0 10px;
}
/* Rich text content styling */
.rich-text-content {
    line-height: 1.6;
}
.rich-text-content p {
    margin-bottom: 1rem;
}
.rich-text-content ul, 
.rich-text-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}
.rich-text-content img {
    max-width: 100%;
    height: auto;
}
.rich-text-content table {
    width: 100%;
    margin-bottom: 1rem;
    border-collapse: collapse;
}
.rich-text-content table td,
.rich-text-content table th {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
}
/* Task modal styles */
.task-modal-content {
    min-height: 600px;
}
.task-description-editor {
    min-height: 200px;
}
</style>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <!-- Project Header -->
    <div class="row mb-4">
        <div class="col">
            <h1>{{ project.name }}</h1>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-md-8">
            <!-- Project Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Project Details</h3>
                </div>
                <div class="card-body">
                    <!-- Project Icon -->
                    <div class="mb-4">
                        <label for="project-icon">Project Icon</label>
                        <input type="text" class="form-control" id="project-icon" name="icon" value="{{ project.icon or 'fas fa-project-diagram' }}">
                    </div>

                    <!-- Project Summary -->
                    <div class="mb-4">
                        <label for="project-summary">Summary</label>
                        <input type="text" class="form-control" id="project-summary" name="summary" value="{{ project.summary }}">
                    </div>

                    <!-- Project Description -->
                    <div class="mb-4">
                        <label for="project-description">Description</label>
                        <textarea class="form-control" id="project-description" name="description" rows="6">{{ project.description }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Tasks Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tasks me-1"></i>
                        Tasks
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#create-task-modal">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% include 'projects/tasks/_table.html' %}
                </div>
            </div>

            <!-- Todo List -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-check-square me-1"></i>
                        Todo List
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#add-todo-modal">
                            <i class="fas fa-plus"></i> Add Todo
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% include 'projects/todos/_list.html' %}
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-comments me-1"></i>
                        Comments
                    </h3>
                </div>
                <div class="card-body">
                    {% include 'projects/comments/_list.html' %}
                </div>
                <div class="card-footer">
                    <form onsubmit="return submitComment();">
                        <div class="input-group">
                            <input type="text" id="comment-content" class="form-control" placeholder="Type Message ...">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- History Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history me-1"></i>
                        Project History
                    </h3>
                </div>
                <div class="card-body">
                    {% include 'projects/history/_list.html' %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-4">
            <!-- Project Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Project Info</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="project-status">Status</label>
                        <select class="form-control" id="project-status" name="status">
                            <option value="planning" {% if project.status == 'planning' %}selected{% endif %}>Planning</option>
                            <option value="active" {% if project.status == 'active' %}selected{% endif %}>Active</option>
                            <option value="completed" {% if project.status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="on_hold" {% if project.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="project-priority">Priority</label>
                        <select class="form-control" id="project-priority" name="priority">
                            <option value="low" {% if project.priority == 'low' %}selected{% endif %}>Low</option>
                            <option value="medium" {% if project.priority == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="high" {% if project.priority == 'high' %}selected{% endif %}>High</option>
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="project-lead">Lead</label>
                        <select class="form-control" id="project-lead" name="lead_id">
                            <option value="">Unassigned</option>
                            {% for member in project.team_members %}
                            <option value="{{ member.id }}" {% if project.lead and project.lead.id == member.id %}selected{% endif %}>
                                {{ member.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <dl class="row">
                        <dt class="col-sm-4">Created</dt>
                        <dd class="col-sm-8">{{ project.created_at|datetime }}</dd>

                        <dt class="col-sm-4">Updated</dt>
                        <dd class="col-sm-8">{{ project.updated_at|datetime }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Team Members -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Team Members</h3>
                </div>
                <div class="card-body">
                    {% include 'projects/details/_team_members.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
{% include 'projects/tasks/_task_modal.html' %}

<!-- Add Todo Modal -->
<div class="modal fade" id="add-todo-modal" tabindex="-1" aria-labelledby="add-todo-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="add-todo-modal-label">Add Todo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="todo-form">
                    <div class="form-group mb-3">
                        <label for="todo-description">Description</label>
                        <input type="text" class="form-control" id="todo-description" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="todo-assigned-to">Assign To</label>
                        <select class="form-control" id="todo-assigned-to">
                            <option value="">Unassigned</option>
                            {% for member in project.team_members %}
                            <option value="{{ member.id }}">{{ member.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createTodo()">Add Todo</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('projects.static', filename='js/tasks.js') }}"></script>
<script>
var currentTaskId = null;
var projectId = {{ project.id }};
var canEdit = true;
var currentUserId = {{ current_user.id }};
</script>
{% endblock %}
