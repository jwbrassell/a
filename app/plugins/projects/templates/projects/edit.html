{% extends 'base.html' %}

{% block title %}Edit {{ project.name }}{% endblock %}

{% block styles %}
{{ super() }}
<!-- Font Awesome Icon Picker -->
<link href="{{ url_for('static', filename='src/fontawesome/css/all.min.css') }}" rel="stylesheet">
<!-- Custom Styles -->
<style>
.todo-list {
    min-height: 100px;
}
.todo-item {
    cursor: move;
    padding: 8px;
    margin: 4px 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.todo-item:hover {
    background: #f8f9fa;
}
.todo-handle {
    cursor: move;
    padding: 0 8px;
}
.todo-content {
    flex-grow: 1;
    margin: 0 8px;
}
.todo-actions {
    visibility: hidden;
}
.todo-item:hover .todo-actions {
    visibility: visible;
}
.history-table th {
    background: #f8f9fa;
}
.direct-chat-messages {
    height: 400px;
}
.direct-chat-text {
    margin: 5px 0 0 10px;
}
.icon-option {
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
}
.icon-option:hover {
    background-color: #f8f9fa;
}
.icon-option.selected {
    background-color: #007bff;
    color: white;
}
.icon-option.selected .text-muted {
    color: #e9ecef !important;
}
.floating-save-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1050;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}
.floating-save-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>
{% endblock %}

{% block head %}
{{ super() }}
<!-- TinyMCE -->
<script src="{{ url_for('static', filename='src/tinymce/tinymce/js/tinymce/tinymce.min.js') }}"></script>
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('projects.index') }}">Projects</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a></li>
    <li class="breadcrumb-item active">Edit</li>
</ol>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <!-- Project Header -->
    <div class="row mb-4">
        <div class="col">
            <h1>Edit {{ project.name }}</h1>
        </div>
    </div>

    <!-- Floating Save Button -->
    <div class="floating-buttons">
        <button type="button" class="btn btn-primary btn-lg floating-save-button" onclick="saveProject()">
            <i class="fas fa-save"></i> Save Changes
        </button>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-md-8">
            <!-- Project Details Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Edit Project</h3>
                    <div class="card-tools">
                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Project Name -->
                    <div class="form-group mb-3">
                        <label>Project Name</label>
                        <input type="text" class="form-control" id="project-name" value="{{ project.name }}">
                    </div>

                    <!-- Project Summary -->
                    <div class="form-group mb-3">
                        <label>Summary</label>
                        <textarea class="form-control" id="project-summary" rows="2">{{ project.summary }}</textarea>
                    </div>

                    <!-- Icon Selector -->
                    <div class="form-group mb-3">
                        <label>Icon</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="{{ project.icon or 'fas fa-project-diagram' }}"></i></span>
                            </div>
                            <input type="text" class="form-control" id="project-icon" value="{{ project.icon }}" placeholder="fas fa-project-diagram">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#icon-picker-modal">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Description Editor -->
                    <div class="form-group mb-3">
                        <label>Description</label>
                        <textarea id="description-editor">{{ project.description }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-4">
            <!-- Project Metadata -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Project Details</h3>
                </div>
                <div class="card-body">
                    <!-- Lead -->
                    <div class="form-group mb-3">
                        <label>Project Lead</label>
                        <select class="form-control" id="lead-select">
                            <option value="">Select Lead...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if project.lead_id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Priority -->
                    <div class="form-group mb-3">
                        <label>Priority</label>
                        <select class="form-control" id="priority-select">
                            {% for priority in priorities %}
                            <option value="{{ priority.id }}" {% if project.priority == priority.name %}selected{% endif %}>
                                {{ priority.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Status -->
                    <div class="form-group mb-3">
                        <label>Status</label>
                        <select class="form-control" id="status-select">
                            {% for status in statuses %}
                            <option value="{{ status.id }}" {% if project.status == status.name %}selected{% endif %}>
                                {{ status.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Last Update -->
                    <div class="form-group mb-3">
                        <label>Last Update</label>
                        <p class="form-control-static">{{ project.updated_at|datetime }}</p>
                    </div>

                    <!-- Percent Complete -->
                    <div class="form-group mb-3">
                        <label>Percent Complete</label>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ project.percent_complete }}%"
                                 aria-valuenow="{{ project.percent_complete }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ project.percent_complete }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Icon Picker Modal -->
<div class="modal fade" id="icon-picker-modal" tabindex="-1" aria-labelledby="icon-picker-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="icon-picker-modal-label">Select Icon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <input type="text" class="form-control" id="icon-search" placeholder="Search icons...">
                </div>
                <div class="row" id="icon-grid">
                    <!-- Icons will be populated here via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSelectedIcon()">Select Icon</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Initialize TinyMCE
tinymce.init({
    selector: '#description-editor',
    height: 300,
    menubar: false,
    plugins: [
        'advlist autolink lists link image charmap print preview anchor',
        'searchreplace visualblocks code fullscreen',
        'insertdatetime media table paste code help wordcount'
    ],
    toolbar: 'undo redo | formatselect | bold italic backcolor | \
             alignleft aligncenter alignright alignjustify | \
             bullist numlist outdent indent | removeformat | help'
});

// Make project ID available to JavaScript
window.projectId = {{ project.id }};
window.canEdit = true;  // Always true in edit mode
window.currentUserId = {{ current_user.id }};
</script>
{% endblock %}
