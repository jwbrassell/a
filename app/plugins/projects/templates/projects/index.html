{% extends 'base.html' %}

{% block title %}Projects{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
    <li class="breadcrumb-item active">Projects</li>
</ol>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <!-- Page header -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <h1 class="m-0 d-inline-block">Projects</h1>
        </div>
        <div class="col text-right">
            <a href="{{ url_for('projects.create') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create Project
            </a>
        </div>
    </div>

    <!-- Project statistics cards -->
    <div class="row mb-4">
        <!-- Active Projects -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-info py-2">
                <div class="inner">
                    <h3>{{ active_projects }}</h3>
                    <p class="mb-0">Active Projects</p>
                </div>
                <div class="icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
            </div>
        </div>

        <!-- Tasks Due Today -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-warning py-2">
                <div class="inner">
                    <h3>{{ tasks_due_today }}</h3>
                    <p class="mb-0">Tasks Due Today</p>
                </div>
                <div class="icon">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
        </div>

        <!-- Open Tasks -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-success py-2">
                <div class="inner">
                    <h3>{{ open_tasks }}</h3>
                    <p class="mb-0">Open Tasks</p>
                </div>
                <div class="icon">
                    <i class="fas fa-tasks"></i>
                </div>
            </div>
        </div>

        <!-- My Assigned Tasks -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-danger py-2">
                <div class="inner">
                    <h3>{{ my_tasks }}</h3>
                    <p class="mb-0">My Assigned Tasks</p>
                </div>
                <div class="icon">
                    <i class="fas fa-user-clock"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Projects -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Active Projects</h3>
        </div>
        <div class="card-body">
            <table id="active-projects-table" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Lead</th>
                        <th>Status</th>
                        <th>Team Size</th>
                        <th>Tasks</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <!-- Archived Projects -->
    <div class="card collapsed-card">
        <div class="card-header">
            <h3 class="card-title">Archived Projects</h3>
            <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="card-body" style="display: none;">
            <table id="archived-projects-table" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Lead</th>
                        <th>Status</th>
                        <th>Team Size</th>
                        <th>Tasks</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <!-- Completed Projects -->
    <div class="card collapsed-card">
        <div class="card-header">
            <h3 class="card-title">Completed Projects</h3>
            <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="card-body" style="display: none;">
            <table id="completed-projects-table" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Lead</th>
                        <th>Status</th>
                        <th>Team Size</th>
                        <th>Tasks</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Delete Project Modal -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Project</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this project? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Flash Messages Data -->
<div id="flash-messages" style="display: none;"
     data-messages="{{ get_flashed_messages(with_categories=true) | tojson }}">
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Set up CSRF token for all AJAX requests
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", $('meta[name="csrf-token"]').attr('content'));
        }
    }
});

let projectToDelete = null;

function initializeDataTable(tableId, projectStatus) {
    const buttons = [
        {
            extend: 'copy',
            exportOptions: {
                columns: [0, 1, 2, 3, 4, 5]
            }
        },
        {
            extend: 'csv',
            exportOptions: {
                columns: [0, 1, 2, 3, 4, 5]
            }
        },
        {
            extend: 'excel',
            title: 'Projects_Export_' + projectStatus,
            exportOptions: {
                columns: [0, 1, 2, 3, 4, 5]
            }
        }
    ];

    return $(tableId).DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{{ url_for('projects.get_projects') }}",
            "data": function(d) {
                d.status = projectStatus;
            },
            "error": function(xhr, error, thrown) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error Loading Data',
                    text: 'Failed to load project data. Please try refreshing the page.'
                });
            }
        },
        "columns": [
            { 
                "data": "name",
                "render": function(data, type, row) {
                    return type === 'display' ? data : $(data).text();
                }
            },
            { "data": "lead" },
            { 
                "data": "status",
                "render": function(data, type, row) {
                    return type === 'display' ? data : $(data).text();
                }
            },
            { "data": "team_size" },
            { "data": "tasks" },
            { "data": "created" },
            { 
                "data": "actions",
                "orderable": false,
                "searchable": false
            }
        ],
        "order": [[5, 'desc']],
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
        "responsive": true,
        "autoWidth": false,
        "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
               "<'row'<'col-sm-12'tr>>" +
               "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>" +
               "<'row'<'col-sm-12'B>>",
        "buttons": buttons,
        "language": {
            "emptyTable": "No " + projectStatus + " projects available",
            "zeroRecords": "No matching projects found",
            "info": "Showing _START_ to _END_ of _TOTAL_ projects",
            "infoEmpty": "Showing 0 to 0 of 0 projects",
            "infoFiltered": "(filtered from _MAX_ total projects)",
            "processing": '<i class="fas fa-spinner fa-spin"></i> Loading...'
        },
        "createdRow": function(row, data, dataIndex) {
            $(row).attr('data-project-id', data.id);
        }
    });
}

$(document).ready(function() {
    // Initialize DataTables
    const activeTable = initializeDataTable('#active-projects-table', 'active');
    const archivedTable = initializeDataTable('#archived-projects-table', 'archived');
    const completedTable = initializeDataTable('#completed-projects-table', 'completed');

    // Reload tables when cards are expanded
    $('.card').on('expanded.lte.cardwidget', function() {
        const tableId = $(this).find('table').attr('id');
        if (tableId === 'archived-projects-table') {
            archivedTable.ajax.reload();
        } else if (tableId === 'completed-projects-table') {
            completedTable.ajax.reload();
        }
    });

    // Handle flash messages
    const flashMessages = JSON.parse($('#flash-messages').attr('data-messages') || '[]');
    flashMessages.forEach(function(message) {
        const [category, text] = message;
        Swal.fire({
            icon: category === 'success' ? 'success' : 'error',
            title: text,
            showConfirmButton: false,
            timer: 3000
        });
    });
});

// Function to show delete confirmation modal
function deleteProject(projectId) {
    projectToDelete = projectId;
    $('#deleteProjectModal').modal('show');
}

// Function to handle project deletion
function confirmDelete() {
    if (!projectToDelete) return;

    const btn = $('#deleteProjectModal .btn-danger').prop('disabled', true);
    
    $.ajax({
        url: "{{ url_for('projects.delete_project', project_id=0) }}".replace('0', projectToDelete),
        method: 'POST',
        success: function(response) {
            $('#deleteProjectModal').modal('hide');
            if (response.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Project deleted successfully',
                    showConfirmButton: false,
                    timer: 1500
                }).then(function() {
                    // Reload all tables
                    $('#active-projects-table').DataTable().ajax.reload();
                    $('#archived-projects-table').DataTable().ajax.reload();
                    $('#completed-projects-table').DataTable().ajax.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error deleting project',
                    text: response.message || 'An unknown error occurred'
                });
            }
        },
        error: function(xhr) {
            $('#deleteProjectModal').modal('hide');
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: xhr.responseJSON?.message || 'Failed to delete project. Please try again.'
            });
        },
        complete: function() {
            btn.prop('disabled', false);
        }
    });
}

// Reset projectToDelete when modal is closed
$('#deleteProjectModal').on('hidden.bs.modal', function() {
    projectToDelete = null;
});
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
.small-box .icon {
    font-size: 50px;
    right: 15px;
    top: 10px;
}
.small-box .inner {
    padding: 10px;
}
.small-box .inner h3 {
    font-size: 25px;
    margin-bottom: 5px;
}
.small-box .inner p {
    font-size: 14px;
}
.dt-buttons {
    margin-top: 1rem;
}
.dt-button {
    margin-right: 0.5rem;
}
.dataTables_processing {
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ddd;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}
