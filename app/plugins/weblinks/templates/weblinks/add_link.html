{% extends "base.html" %}

{% block page_content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Add New Web Link</h1>
            <a href="{{ url_for('weblinks.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Links
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Link Details</h3>
                </div>
                <div class="card-body">
                    <form method="POST" id="addLinkForm">
                        {{ form.csrf_token }}
                        
                        <div class="form-group">
                            <label for="url">URL *</label>
                            {{ form.url(class="form-control", placeholder="https://example.com") }}
                            {% if form.url.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.url.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="friendly_name">Friendly Name *</label>
                            {{ form.friendly_name(class="form-control", placeholder="My Website") }}
                            {% if form.friendly_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.friendly_name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="category">Category</label>
                            <div class="input-group">
                                {{ form.category(class="form-control") }}
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                        <i class="fas fa-plus"></i> New Category
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tags">Tags</label>
                            <select class="form-control select2-tags" name="tags" multiple="multiple">
                                {% for tag in tags %}
                                <option value="{{ tag.id }}">{{ tag.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="icon">Icon</label>
                            <div class="input-group">
                                {{ form.icon(class="form-control") }}
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" id="iconPickerBtn">
                                        <i class="fas fa-icons"></i> Choose Icon
                                    </button>
                                </div>
                            </div>
                            <div id="iconPreview" class="mt-2">
                                <i class="fas fa-link"></i>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes">Notes</label>
                            {{ form.notes(class="form-control", rows="3") }}
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Link
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Icon Preview</h3>
                </div>
                <div class="card-body">
                    <div id="iconGrid" class="row">
                        <!-- Icons will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="close" data-bs-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label for="categoryName">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save Category</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Initialize form state based on errors and success -->
<script>
    var hasFormErrors = {% if form.errors %}true{% else %}false{% endif %};
    var hasSuccess = {% if get_flashed_messages(category_filter=['success']) %}true{% else %}false{% endif %};
</script>

<script>
$(document).ready(function() {
    // Initialize Select2 with tag creation
    $('.select2-tags').select2({
        theme: 'bootstrap4',
        placeholder: 'Select or type to create tags',
        tags: true,
        tokenSeparators: [',', ' '],
        createTag: function(params) {
            return {
                id: params.term,
                text: params.term,
                newTag: true
            };
        }
    }).on('select2:select', function(e) {
        if (e.params.data.newTag) {
            // Create new tag in the backend
            $.post("{{ url_for('weblinks.add_tag') }}", {
                name: e.params.data.text,
                csrf_token: "{{ csrf_token() }}"
            })
            .done(function(response) {
                if (response.success) {
                    // Update the option with the real tag ID
                    var option = $(`.select2-tags option[value="${e.params.data.text}"]`);
                    option.val(response.id);
                    option.text(response.name);
                    $('.select2-tags').trigger('change');
                }
            });
        }
    });

    // Load icons
    function loadIcons() {
        $.get("{{ url_for('weblinks.get_icons') }}", function(icons) {
            const iconGrid = $('#iconGrid');
            iconGrid.empty();
            
            icons.forEach(icon => {
                const iconDiv = $(`
                    <div class="col-3 mb-3">
                        <button class="btn btn-outline-secondary icon-select w-100" data-icon="${icon}">
                            <i class="fas ${icon}"></i>
                        </button>
                    </div>
                `);
                iconGrid.append(iconDiv);
            });
        });
    }

    // Icon selection
    $(document).on('click', '.icon-select', function() {
        const icon = $(this).data('icon');
        $('#icon').val(icon);
        $('#iconPreview i').attr('class', `fas ${icon}`);
    });

    // Add new category
    $('#saveCategoryBtn').click(function() {
        const name = $('#categoryName').val();
        if (!name) return;

        $.post("{{ url_for('weblinks.add_category') }}", {
            name: name,
            csrf_token: "{{ csrf_token() }}"
        })
        .done(function(response) {
            if (response.success) {
                const option = new Option(response.name, response.id, true, true);
                $('#category').append(option).trigger('change');
                $('#addCategoryModal').modal('hide');
                $('#categoryName').val('');
            }
        });
    });

    // Form data persistence
    const formKey = 'weblink_form_data';
    
    // Clear form data if there was a successful save
    if (hasSuccess) {
        localStorage.removeItem(formKey);
        // Also clear form fields
        $('#addLinkForm')[0].reset();
        $('.select2-tags').val(null).trigger('change');
        $('#iconPreview i').attr('class', 'fas fa-link');
    } else {
        // Load saved form data only if there was no success
        const savedData = localStorage.getItem(formKey);
        if (savedData) {
            const formData = JSON.parse(savedData);
            Object.keys(formData).forEach(key => {
                const input = $(`[name="${key}"]`);
                if (input.length) {
                    if (input.hasClass('select2-tags')) {
                        input.val(formData[key].split(',')).trigger('change');
                    } else {
                        input.val(formData[key]);
                    }
                }
            });
        }
    }

    // Save form data before submit only if there are errors
    $('#addLinkForm').on('submit', function() {
        if (hasFormErrors) {
            const formData = {};
            $(this).serializeArray().forEach(item => {
                if (item.name === 'tags') {
                    formData[item.name] = $('.select2-tags').val().join(',');
                } else {
                    formData[item.name] = item.value;
                }
            });
            localStorage.setItem(formKey, JSON.stringify(formData));
        } else {
            localStorage.removeItem(formKey);
        }
    });

    // Initial icon load
    loadIcons();
});
</script>
{% endblock %}
