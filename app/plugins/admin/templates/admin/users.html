{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block styles %}
{{ super() }}
<style>
.role-badge {
    margin: 2px;
    cursor: pointer;
}
.user-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
}
.activity-chart {
    min-height: 300px;
}
.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
}
.status-active { background-color: #00a65a; }
.status-inactive { background-color: #dd4b39; }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">User Management</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Admin</a></li>
                        <li class="breadcrumb-item active">Users</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- User Statistics -->
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3>{{ users|length }}</h3>
                            <p>Total Users</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3 id="activeUsers">0</h3>
                            <p>Active Users</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3 id="newUsers">0</h3>
                            <p>New Users (Last 30 Days)</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3 id="inactiveUsers">0</h3>
                            <p>Inactive Users</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-times"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Activity Chart -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line mr-1"></i>
                                User Activity
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="userActivityChart" class="activity-chart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-pie mr-1"></i>
                                Role Distribution
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="roleDistributionChart" class="activity-chart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Users</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newUserModal">
                            <i class="fas fa-user-plus"></i> New User
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table id="usersTable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Roles</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <img src="{{ user.avatar_url|default('/static/images/default-avatar.png', true) }}" 
                                         class="user-avatar mr-2" alt="Avatar">
                                    {{ user.username }}
                                </td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% for role in user.roles %}
                                    <span class="badge badge-info role-badge" 
                                          data-toggle="tooltip" 
                                          title="Click to edit roles"
                                          onclick="editUserRoles({{ user.id }})">
                                        <i class="{{ role.icon }}"></i> {{ role.name }}
                                    </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <span class="status-indicator status-{{ 'active' if user.is_active else 'inactive' }}"></span>
                                    {{ 'Active' if user.is_active else 'Inactive' }}
                                </td>
                                <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M:%S') if user.last_login else 'Never' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editUser({{ user.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="resetPassword({{ user.id }})">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    <button class="btn btn-sm btn-{{ 'danger' if user.is_active else 'success' }}" 
                                            onclick="toggleUserStatus({{ user.id }})">
                                        <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Edit Roles Modal -->
<div class="modal fade" id="editRolesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User Roles</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editRolesForm">
                    <input type="hidden" id="editUserId" name="user_id">
                    <div class="form-group">
                        <label>Roles</label>
                        <select class="form-control select2" name="roles[]" multiple>
                            {% for role in all_roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUserRoles()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- New User Modal -->
<div class="modal fade" id="newUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New User</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newUserForm">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="form-group">
                        <label>Roles</label>
                        <select class="form-control select2" name="roles[]" multiple>
                            {% for role in all_roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#usersTable').DataTable({
        "responsive": true,
        "lengthChange": true,
        "autoWidth": false,
        "buttons": ["copy", "csv", "excel", "pdf", "print"]
    }).buttons().container().appendTo('#usersTable_wrapper .col-md-6:eq(0)');

    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap4'
    });

    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();

    // Initialize charts
    initializeCharts();
    
    // Update statistics
    updateUserStats();
});

function initializeCharts() {
    // User Activity Chart
    Highcharts.chart('userActivityChart', {
        chart: { type: 'spline' },
        title: { text: 'User Activity Over Time' },
        xAxis: { type: 'datetime' },
        yAxis: { title: { text: 'Actions' } },
        series: [{
            name: 'User Actions',
            data: [] // Will be populated via AJAX
        }]
    });

    // Role Distribution Chart
    Highcharts.chart('roleDistributionChart', {
        chart: { type: 'pie' },
        title: { text: 'Role Distribution' },
        series: [{
            name: 'Users',
            data: [] // Will be populated via AJAX
        }]
    });
}

function updateUserStats() {
    fetch('/admin/api/user-stats')
        .then(response => response.json())
        .then(data => {
            $('#activeUsers').text(data.active);
            $('#inactiveUsers').text(data.inactive);
            $('#newUsers').text(data.new);
            
            // Update activity chart
            const activityChart = Highcharts.charts.find(c => c.renderTo.id === 'userActivityChart');
            if (activityChart) {
                activityChart.series[0].setData(data.activity);
            }
            
            // Update role distribution chart
            const roleChart = Highcharts.charts.find(c => c.renderTo.id === 'roleDistributionChart');
            if (roleChart) {
                roleChart.series[0].setData(data.roles);
            }
        });
}

function editUserRoles(userId) {
    $('#editUserId').val(userId);
    fetch(`/admin/api/users/${userId}/roles`)
        .then(response => response.json())
        .then(data => {
            $('select[name="roles[]"]').val(data.role_ids).trigger('change');
            $('#editRolesModal').modal('show');
        });
}

function saveUserRoles() {
    const form = $('#editRolesForm');
    const userId = $('#editUserId').val();
    
    fetch(`/admin/users/${userId}/roles`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
            roles: $('select[name="roles[]"]').val()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#editRolesModal').modal('hide');
            location.reload();
        } else {
            toastr.error(data.error);
        }
    });
}

function createUser() {
    const form = $('#newUserForm');
    const formData = new FormData(form[0]);
    
    fetch('/admin/api/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#newUserModal').modal('hide');
            location.reload();
        } else {
            toastr.error(data.error);
        }
    });
}

function toggleUserStatus(userId) {
    fetch(`/admin/api/users/${userId}/toggle-status`, {
        method: 'POST',
        headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            toastr.error(data.error);
        }
    });
}

function resetPassword(userId) {
    if (confirm('Are you sure you want to reset this user\'s password?')) {
        fetch(`/admin/api/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                toastr.success('Password reset email sent');
            } else {
                toastr.error(data.error);
            }
        });
    }
}
</script>
{% endblock %}
