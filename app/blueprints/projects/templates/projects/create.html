{% extends 'projects/layouts/_two_column.html' %}

{% block title %}Create New Project{% endblock %}

{% block header %}
<div class="row mb-4">
    <div class="col">
        <h1>
            <i class="fas fa-plus me-2"></i>
            Create New Project
        </h1>
        <p class="text-muted">Create a new project to track tasks and manage progress</p>
    </div>
</div>
{% endblock %}

{% block page_content %}
<form id="projectForm" class="container-fluid">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="created_by" value="{{ current_user.username }}">
    <div class="row">
        <!-- Left Column -->
        <div class="col-md-9">
            <!-- Project Details -->
            {% include 'projects/components/_project_details.html' %}

            <!-- Tasks Table -->
            <div class="card mb-4">
                <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#tasksCollapse" aria-expanded="true" aria-controls="tasksCollapse">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-tasks me-1"></i>
                            Tasks
                        </h3>
                        <i class="fas fa-minus collapse-icon"></i>
                    </div>
                </div>
                <div class="collapse show" id="tasksCollapse">
                    <div class="card-body">
                        {% include 'projects/tasks/_table.html' %}
                    </div>
                </div>
            </div>

            <!-- Todo List -->
            <div class="card mb-4">
                <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#todosCollapse" aria-expanded="true" aria-controls="todosCollapse">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-check-square me-1"></i>
                            Todo List
                        </h3>
                        <i class="fas fa-minus todos-collapse-icon"></i>
                    </div>
                </div>
                <div class="collapse show" id="todosCollapse">
                    <div class="card-body p-0">
                        {% include 'projects/todos/_list.html' %}
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card mb-4">
                <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#commentsCollapse" aria-expanded="false" aria-controls="commentsCollapse">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-comments me-1"></i>
                            Comments
                        </h3>
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="collapse" id="commentsCollapse">
                    <div class="card-body">
                        {% include 'projects/comments/_list.html' %}
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="card">
                <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-history me-1"></i>
                            Project History
                        </h3>
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="collapse" id="historyCollapse">
                    <div class="card-body">
                        {% include 'projects/history/_list.html' %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-3">
            <!-- Project Info -->
            {% include 'projects/components/_project_info.html' %}
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-action-group">
        <button type="button" class="btn btn-primary btn-lg" onclick="projectModule.createProject('edit')">
            <i class="fas fa-save me-1"></i> Create & Edit
        </button>
        <button type="button" class="btn btn-secondary btn-lg" onclick="projectModule.createProject('close')">
            <i class="fas fa-check me-1"></i> Create & Close
        </button>
    </div>
</form>
{% endblock %}

{% block modals %}
<!-- Task Modal -->
{% include 'projects/tasks/_task_modal.html' %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Initialize project variables
window.currentUserId = {{ current_user.id }};
window.projectId = null; // Since this is a new project
window.APP = {
    projectId: null,
    taskId: null,
    userId: {{ current_user.id }},
    username: "{{ current_user.username }}"
};

// Handle collapse icon changes
document.addEventListener('DOMContentLoaded', function() {
    // Tasks collapse functionality
    const tasksCollapse = document.getElementById('tasksCollapse');
    const tasksCollapseIcon = tasksCollapse.previousElementSibling.querySelector('.collapse-icon');
    
    tasksCollapse.addEventListener('show.bs.collapse', function() {
        tasksCollapseIcon.classList.remove('fa-plus');
        tasksCollapseIcon.classList.add('fa-minus');
    });
    
    tasksCollapse.addEventListener('hide.bs.collapse', function() {
        tasksCollapseIcon.classList.remove('fa-minus');
        tasksCollapseIcon.classList.add('fa-plus');
    });

    // Todos collapse functionality
    const todosCollapse = document.getElementById('todosCollapse');
    const todosCollapseIcon = todosCollapse.previousElementSibling.querySelector('.todos-collapse-icon');
    
    todosCollapse.addEventListener('show.bs.collapse', function() {
        todosCollapseIcon.classList.remove('fa-plus');
        todosCollapseIcon.classList.add('fa-minus');
    });
    
    todosCollapse.addEventListener('hide.bs.collapse', function() {
        todosCollapseIcon.classList.remove('fa-minus');
        todosCollapseIcon.classList.add('fa-plus');
    });

    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5'
    });

    // Prevent form submission on enter
    document.getElementById('projectForm').addEventListener('submit', function(e) {
        e.preventDefault();
    });
});
</script>
{% endblock %}
