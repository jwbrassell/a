{% extends 'projects/layouts/_two_column.html' %}

{% block title %}Edit {{ task.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.list_projects') }}">Projects</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.view_project', project_id=task.project.id) }}">{{ task.project.name }}</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.view_task', task_id=task.id) }}">{{ task.name }}</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
.todo-list {
    min-height: unset;
}
.todo-item {
    padding: 8px;
    margin: 4px 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.history-table th {
    background: #f8f9fa;
}
.direct-chat-messages {
    height: 400px;
    overflow-y: auto;
}
.direct-chat-text {
    margin: 5px 0 0 10px;
}
</style>
{% endblock %}

{% block left_column %}
<form id="taskForm" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- Task Details -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">
                <i class="fas fa-tasks me-1"></i>
                Task Details
            </h3>
        </div>
        <div class="card-body">
            <!-- Name -->
            <div class="form-group mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" name="name" value="{{ task.name }}" required>
            </div>

            <!-- Summary -->
            <div class="form-group mb-3">
                <label class="form-label">Summary</label>
                <input type="text" class="form-control" name="summary" value="{{ task.summary }}">
            </div>

            <!-- Description -->
            <div class="form-group mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="5">{{ task.description }}</textarea>
            </div>
        </div>
    </div>

    <!-- Task Todo List -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#todosCollapse" aria-expanded="true" aria-controls="todosCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-check-square me-1"></i>
                    Task Todo List
                </h3>
                <i class="fas fa-minus todos-collapse-icon"></i>
            </div>
        </div>
        <div class="collapse show" id="todosCollapse">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width: 10px">#</th>
                                <th>Description</th>
                                <th style="width: 100px">Due</th>
                                <th style="width: 50px">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="taskTodoList">
                            {% for todo in task.todos %}
                            <tr data-todo-id="{{ todo.id }}">
                                <td class="text-center">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input todo-checkbox" 
                                               id="todoCheck{{ todo.id }}" 
                                               name="todos[{{ loop.index0 }}][completed]"
                                               {% if todo.completed %}checked{% endif %}>
                                        <label class="form-check-label" for="todoCheck{{ todo.id }}"></label>
                                    </div>
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm todo-description" 
                                           name="todos[{{ loop.index0 }}][description]"
                                           value="{{ todo.description }}" 
                                           required>
                                </td>
                                <td>
                                    <input type="date" class="form-control form-control-sm todo-due-date"
                                           name="todos[{{ loop.index0 }}][due_date]"
                                           value="{{ todo.due_date }}">
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-danger btn-sm remove-todo" title="Remove Todo">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not task.todos %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No todo items found.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-end bg-transparent">
                    <button type="button" class="btn btn-primary btn-sm" id="addTaskTodoBtn">
                        <i class="fas fa-plus me-1"></i>Add Todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#commentsCollapse" aria-expanded="false" aria-controls="commentsCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-comments me-1"></i>
                    Comments
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="commentsCollapse">
            <div class="card-body">
                <div class="direct-chat-messages" id="taskCommentsList">
                    {% for comment in task.comments %}
                    <div class="direct-chat-msg">
                        <div class="direct-chat-infos clearfix">
                            <span class="direct-chat-name float-left">{{ comment.user.username }}</span>
                            <span class="direct-chat-timestamp float-right">{{ comment.created_at|datetime }}</span>
                        </div>
                        <img class="direct-chat-img" src="{{ comment.user.get_preference('avatar', 'images/user_1.jpg') }}" alt="User Image">
                        <div class="direct-chat-text">{{ comment.content }}</div>
                    </div>
                    {% endfor %}
                    {% if not task.comments %}
                    <div class="text-center text-muted">No comments yet</div>
                    {% endif %}
                </div>
                <div class="input-group mt-3">
                    <input type="text" class="form-control" id="taskCommentInput" placeholder="Type your comment...">
                    <button class="btn btn-primary" type="button" id="addTaskCommentBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Table -->
    <div class="card">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-history me-1"></i>
                    Task History
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="historyCollapse">
            <div class="card-body">
                {% include 'projects/history/_list.html' %}
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block right_column %}
    <!-- Task Info -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">
                <i class="fas fa-info-circle me-1"></i>
                Task Information
            </h3>
        </div>
        <div class="card-body">
            <!-- Status -->
            <div class="form-group mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" name="status" form="taskForm">
                    {% for status in statuses %}
                    <option value="{{ status.name }}" data-color="{{ status.color }}" {% if task.status and task.status.name == status.name %}selected{% endif %}>
                        {{ status.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Priority -->
            <div class="form-group mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" name="priority" form="taskForm">
                    {% for priority in priorities %}
                    <option value="{{ priority.name }}" data-color="{{ priority.color }}" {% if task.priority and task.priority.name == priority.name %}selected{% endif %}>
                        {{ priority.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Lead -->
            <div class="form-group mb-3">
                <label class="form-label">Lead</label>
                <select class="form-select" name="assigned_to_id" form="taskForm">
                    <option value="">Unassigned</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if task.assigned_to_id == user.id %}selected{% endif %}>
                        {{ user.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Due Date -->
            <div class="form-group mb-3">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-control" name="due_date" form="taskForm" value="{{ task.due_date }}">
            </div>

            <!-- Created -->
            <div class="form-group mb-3">
                <label class="form-label">Created</label>
                <div>{{ task.created_at|datetime }}</div>
            </div>

            <!-- Last Updated -->
            <div class="form-group mb-3">
                <label class="form-label">Last Updated</label>
                <div>{{ task.updated_at|datetime }}</div>
            </div>
        </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" form="taskForm" class="btn btn-primary btn-lg w-100 mb-4">
        <i class="fas fa-save me-1"></i> Save Changes
    </button>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
window.APP = window.APP || {};
window.APP.taskId = {{ task.id|tojson|safe }};
window.APP.projectId = {{ task.project.id|tojson|safe }};
</script>
<script src="{{ url_for('projects.static', filename='js/tasks.js') }}"></script>
{% endblock %}
