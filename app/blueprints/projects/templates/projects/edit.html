{% extends 'projects/layouts/_two_column.html' %}

{% block title %}{{ project.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.list_projects') }}">Projects</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block additional_styles %}
<style>
.todo-list {
    min-height: 100px;
}
.todo-item {
    padding: 8px;
    margin: 4px 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.todo-item:hover {
    background: #f8f9fa;
}
.todo-content {
    flex-grow: 1;
    margin: 0 8px;
}
.history-table th {
    background: #f8f9fa;
}
.direct-chat-messages {
    height: 400px;
    overflow-y: auto;
}
.direct-chat-text {
    margin: 5px 0 0 10px;
}
/* Rich text content styling */
.rich-text-content {
    line-height: 1.6;
}
.rich-text-content p {
    margin-bottom: 1rem;
}
.rich-text-content ul, 
.rich-text-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}
.rich-text-content img {
    max-width: 100%;
    height: auto;
}
.rich-text-content table {
    width: 100%;
    margin-bottom: 1rem;
    border-collapse: collapse;
}
.rich-text-content table td,
.rich-text-content table th {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
}
/* Task modal styles */
.task-modal-content {
    min-height: 600px;
}
.task-description-editor {
    min-height: 200px;
}
</style>
{% endblock %}

{% block left_column %}
    <!-- Project Details -->
    {% include 'projects/components/_project_details.html' %}

    <!-- Tasks Table -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#tasksCollapse" aria-expanded="true" aria-controls="tasksCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-tasks me-1"></i>
                    Tasks
                </h3>
                <i class="fas fa-minus collapse-icon"></i>
            </div>
        </div>
        <div class="collapse show" id="tasksCollapse">
            <div class="card-body">
                {% include 'projects/tasks/_table.html' %}
            </div>
        </div>
    </div>

    <!-- Todo List -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#todosCollapse" aria-expanded="true" aria-controls="todosCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-check-square me-1"></i>
                    Todo List
                </h3>
                <i class="fas fa-minus todos-collapse-icon"></i>
            </div>
        </div>
        <div class="collapse show" id="todosCollapse">
            <div class="card-body p-0">
                {% with readonly=false, project=project %}
                {% include 'projects/todos/_list.html' %}
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card mb-4">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#commentsCollapse" aria-expanded="false" aria-controls="commentsCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-comments me-1"></i>
                    Comments
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="commentsCollapse">
            <div class="card-body">
                {% include 'projects/comments/_list.html' %}
            </div>
        </div>
    </div>

    <!-- History Table -->
    <div class="card">
        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-history me-1"></i>
                    Project History
                </h3>
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="collapse" id="historyCollapse">
            <div class="card-body">
                {% include 'projects/history/_list.html' %}
            </div>
        </div>
    </div>
{% endblock %}

{% block right_column %}
    <!-- Project Info -->
    {% include 'projects/components/_project_info.html' %}

    <!-- Save Changes Button -->
    <button type="button" class="btn btn-primary btn-lg w-100 mb-4" onclick="projectModule.saveProject()">
        <i class="fas fa-save me-1"></i> Save Changes
    </button>
{% endblock %}

{% block modals %}
<!-- Task Modal -->
{% include 'projects/tasks/_task_modal.html' %}
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- jQuery (required for select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Toastr -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Debug script -->
<script>
// Initialize debug logging
window.debugLog = function(msg) {
    console.log(`[DEBUG ${new Date().toISOString()}] ${msg}`);
};

// Log initial page load
debugLog('Page loaded');
</script>

<!-- Project variables -->
<script>
window.projectId = {{ project.id }};
window.currentUserId = {{ current_user.id }};

// Handle collapse icon changes
document.addEventListener('DOMContentLoaded', function() {
    debugLog('DOMContentLoaded event fired');

    // Tasks collapse functionality
    const tasksCollapse = document.getElementById('tasksCollapse');
    const tasksCollapseIcon = tasksCollapse.previousElementSibling.querySelector('.collapse-icon');
    
    tasksCollapse.addEventListener('show.bs.collapse', function() {
        tasksCollapseIcon.classList.remove('fa-plus');
        tasksCollapseIcon.classList.add('fa-minus');
    });
    
    tasksCollapse.addEventListener('hide.bs.collapse', function() {
        tasksCollapseIcon.classList.remove('fa-minus');
        tasksCollapseIcon.classList.add('fa-plus');
    });

    // Todos collapse functionality
    const todosCollapse = document.getElementById('todosCollapse');
    const todosCollapseIcon = todosCollapse.previousElementSibling.querySelector('.todos-collapse-icon');
    
    todosCollapse.addEventListener('show.bs.collapse', function() {
        todosCollapseIcon.classList.remove('fa-plus');
        todosCollapseIcon.classList.add('fa-minus');
    });
    
    todosCollapse.addEventListener('hide.bs.collapse', function() {
        todosCollapseIcon.classList.remove('fa-minus');
        todosCollapseIcon.classList.add('fa-plus');
    });
});
</script>

<!-- Project functionality -->
<script src="{{ url_for('projects.static', filename='js/project.js') }}"></script>
<script>
// Verify project.js is loaded
debugLog('Checking projectModule...');
debugLog('projectModule: ' + (window.projectModule ? 'LOADED' : 'NOT LOADED'));
debugLog('projectModule functions: ' + Object.keys(window.projectModule || {}).join(', '));
</script>

<!-- Load todos.js after project.js -->
<script src="{{ url_for('projects.static', filename='js/tasks.js') }}"></script>
<script src="{{ url_for('projects.static', filename='js/todos.js') }}"></script>
<script>
// Verify todos.js is loaded
debugLog('Checking todoModule...');
debugLog('todoModule: ' + (window.todoModule ? 'LOADED' : 'NOT LOADED'));
debugLog('todoModule functions: ' + Object.keys(window.todoModule || {}).join(', '));

// Add direct click handler for Add Todo button
document.addEventListener('DOMContentLoaded', function() {
    const addTodoBtn = document.getElementById('addTodoBtn');
    if (addTodoBtn) {
        debugLog('Found Add Todo button');
        addTodoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            debugLog('Add Todo button clicked via event listener');
            if (window.todoModule && window.todoModule.showNewTodoForm) {
                window.todoModule.showNewTodoForm();
            } else {
                console.error('todoModule or showNewTodoForm not found');
            }
        });
    } else {
        debugLog('Add Todo button not found');
    }
});
</script>

<script src="{{ url_for('projects.static', filename='js/comments.js') }}"></script>
{% endblock %}
