{% extends "aws/base_aws.html" %}

{% block aws_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>EC2 Launch Templates</h2>
            <button class="btn btn-primary" data-toggle="modal" data-target="#newTemplateModal">
                <i class="fas fa-plus"></i> New Template
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="table-responsive">
            <table class="table table-striped aws-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Instance Type</th>
                        <th>AMI ID</th>
                        <th>Key Name</th>
                        <th>Security Groups</th>
                        <th>Instances</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for template in templates %}
                    <tr>
                        <td>{{ template.name }}</td>
                        <td>{{ template.instance_type }}</td>
                        <td>{{ template.ami_id }}</td>
                        <td>{{ template.key_name or 'N/A' }}</td>
                        <td>{{ template.security_groups|length if template.security_groups else 0 }}</td>
                        <td>{{ template.instance_count }}</td>
                        <td>{{ template.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-info" 
                                        onclick='viewTemplate({{ template.id }})'>
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" 
                                        onclick="deleteTemplate({{ template.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Template Modal -->
<div class="modal fade" id="newTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Launch Template</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newTemplateForm">
                    <div class="form-group">
                        <label>Template Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Instance Type</label>
                        <select class="form-control" name="instance_type" required>
                            <optgroup label="General Purpose">
                                <option value="t2.micro">t2.micro</option>
                                <option value="t2.small">t2.small</option>
                                <option value="t2.medium">t2.medium</option>
                                <option value="t3.micro">t3.micro</option>
                                <option value="t3.small">t3.small</option>
                                <option value="t3.medium">t3.medium</option>
                            </optgroup>
                            <optgroup label="Compute Optimized">
                                <option value="c5.large">c5.large</option>
                                <option value="c5.xlarge">c5.xlarge</option>
                                <option value="c5.2xlarge">c5.2xlarge</option>
                            </optgroup>
                            <optgroup label="Memory Optimized">
                                <option value="r5.large">r5.large</option>
                                <option value="r5.xlarge">r5.xlarge</option>
                                <option value="r5.2xlarge">r5.2xlarge</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>AMI ID</label>
                        <input type="text" class="form-control" name="ami_id" required
                               pattern="ami-[a-f0-9]{8,17}"
                               title="Valid AMI ID (e.g., ami-0123456789abcdef0)">
                    </div>
                    <div class="form-group">
                        <label>Key Name (Optional)</label>
                        <input type="text" class="form-control" name="key_name">
                    </div>
                    <div class="form-group">
                        <label>Security Groups (Optional)</label>
                        <select multiple class="form-control" name="security_groups">
                            <!-- Populated by JavaScript -->
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple groups</small>
                    </div>
                    <div class="form-group">
                        <label>User Data Script (Optional)</label>
                        <textarea class="form-control" name="user_data" rows="5"
                                  placeholder="#!/bin/bash"></textarea>
                        <small class="form-text text-muted">Bash script to run when instance launches</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTemplate()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- View Template Modal -->
<div class="modal fade" id="viewTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Template Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <dl>
                            <dt>Name</dt>
                            <dd id="template-name"></dd>
                            <dt>Description</dt>
                            <dd id="template-description"></dd>
                            <dt>Instance Type</dt>
                            <dd id="template-instance-type"></dd>
                            <dt>AMI ID</dt>
                            <dd id="template-ami-id"></dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6>Configuration</h6>
                        <dl>
                            <dt>Key Name</dt>
                            <dd id="template-key-name"></dd>
                            <dt>Security Groups</dt>
                            <dd id="template-security-groups"></dd>
                            <dt>Created</dt>
                            <dd id="template-created-at"></dd>
                        </dl>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>User Data Script</h6>
                        <pre id="template-user-data" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block aws_scripts %}
<script>
function loadSecurityGroups() {
    fetch("{{ url_for('aws_manager.list_security_groups', config_id=config.id) }}", {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(groups => {
        const select = document.querySelector('select[name="security_groups"]');
        select.innerHTML = '';
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.group_id;
            option.textContent = `${group.group_name} (${group.group_id})`;
            select.appendChild(option);
        });
    })
    .catch(error => showError('Failed to load security groups: ' + error.message));
}

function createTemplate() {
    const form = document.getElementById('newTemplateForm');
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        instance_type: formData.get('instance_type'),
        ami_id: formData.get('ami_id'),
        key_name: formData.get('key_name'),
        security_groups: Array.from(form.security_groups.selectedOptions).map(option => option.value),
        user_data: formData.get('user_data')
    };

    fetch("{{ url_for('aws_manager.create_template', config_id=config.id) }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create template');
        }
        return response.json();
    })
    .then(data => {
        $('#newTemplateModal').modal('hide');
        showSuccess('Template created successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        showError('Failed to create template: ' + error.message);
    });
}

function viewTemplate(templateId) {
    fetch("{{ url_for('aws_manager.list_templates', config_id=config.id) }}/" + templateId)
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load template details');
        }
        return response.json();
    })
    .then(template => {
        document.getElementById('template-name').textContent = template.name;
        document.getElementById('template-description').textContent = template.description || 'No description';
        document.getElementById('template-instance-type').textContent = template.instance_type;
        document.getElementById('template-ami-id').textContent = template.ami_id;
        document.getElementById('template-key-name').textContent = template.key_name || 'N/A';
        document.getElementById('template-security-groups').textContent = 
            template.security_groups?.join(', ') || 'None';
        document.getElementById('template-created-at').textContent = 
            new Date(template.created_at).toLocaleString();
        document.getElementById('template-user-data').textContent = 
            template.user_data || 'No user data script';
        
        $('#viewTemplateModal').modal('show');
    })
    .catch(error => {
        showError('Failed to load template details: ' + error.message);
    });
}

function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) {
        return;
    }

    fetch("{{ url_for('aws_manager.list_templates', config_id=config.id) }}/" + templateId, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to delete template');
        }
        showSuccess('Template deleted successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        showError('Failed to delete template: ' + error.message);
    });
}

// Load security groups when creating new template
document.getElementById('newTemplateModal').addEventListener('show.bs.modal', loadSecurityGroups);
</script>
{% endblock %}
