 {% extends "base.html" %}

{% block styles %}
<style>
.dataTables_processing,
.dataTables_empty,
.dataTables_loading,
.dataTables_message,
.dataTables_overlay {
    display: none !important;
}

/* Hide any loading spinners */
.loading,
.processing,
.dt-loading {
    display: none !important;
}

/* Force hide ajax loader */
#ajax-loader {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}
</style>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Bug Reports Administration</h2>
        <div class="btn-group">
            <button type="button" class="btn btn-primary" id="exportReports">
                <i class="fas fa-download"></i> Export to CSV
            </button>
            <button type="button" class="btn btn-danger" id="bulkDelete" disabled>
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Filters</h5>
        </div>
        <div class="card-body">
            <form id="filterForm" class="row g-3 ajax-form">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter" multiple>
                        <option value="open">Open</option>
                        <option value="solved">Solved</option>
                        <option value="not_actionable">Not Actionable</option>
                        <option value="merged">Merged</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <select class="form-select" id="dateFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Occurrence Type</label>
                    <select class="form-select" id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="intermittent">Intermittent</option>
                        <option value="consistent">Consistent</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Route</label>
                    <input type="text" class="form-control" id="routeFilter" placeholder="Filter by route">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <button type="button" class="btn btn-secondary" id="resetFilters">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Reports</h5>
                    <h2 class="mb-0" id="totalReports">{{ stats.total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Open Reports</h5>
                    <h2 class="mb-0" id="openReports">{{ stats.open }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Solved Reports</h5>
                    <h2 class="mb-0" id="solvedReports">{{ stats.solved }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Average Resolution Time</h5>
                    <h2 class="mb-0" id="avgResolutionTime">{{ stats.avg_resolution_time }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="card position-relative">
        <div class="card-header">
            <h5 class="mb-0">All Reports</h5>
        </div>
        <div class="card-body">
            <table id="adminReportsTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th>ID</th>
                        <th>Reported By</th>
                        <th>Route</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the selected bug report(s)? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Remove ajax loader element completely
    const loader = document.getElementById('ajax-loader');
    if (loader) loader.remove();

    // Override loader functions
    window.showAjaxLoader = function() {};
    window.hideAjaxLoader = function() {};

    // Debug flag
    const DEBUG = true;
    
    // Initialize DataTable
    const table = $('#adminReportsTable').DataTable({
        processing: false,
        serverSide: true,
        language: {
            processing: '',  // Remove processing text
            loadingRecords: '',  // Remove loading text
            zeroRecords: '',  // Remove initial loading text
            infoEmpty: ''  // Remove empty table text
        },
        preDrawCallback: function() {
            window.hideAjaxLoader();
            return true;
        },
        ajax: {
            url: '/bug_reports/admin/data',
            type: 'GET',
            data: function(d) {
                if (DEBUG) console.log('DataTables requesting data:', d);
                
                // Get filter values
                const statusValues = $('#statusFilter').val() || [];
                
                // Add custom filters
                const filters = {
                    type: $('#typeFilter').val(),
                    route: $('#routeFilter').val(),
                    date: $('#dateFilter').val()
                };
                
                // Add status values
                statusValues.forEach((status, index) => {
                    filters[`status[${index}]`] = status;
                });
                
                // Combine with DataTables params
                return {...d, ...filters};
            },
            error: function(xhr, error, thrown) {
                console.error('DataTables error:', error);
                showToast('Error loading data: ' + error, 'error');
            }
        },
        columns: [
            { 
                data: null,
                render: function(data) {
                    return `<input type="checkbox" class="form-check-input report-select" data-id="${data.id}">`;
                },
                orderable: false
            },
            { data: 'id' },
            { data: 'user' },
            { data: 'route' },
            { data: 'type' },
            { 
                data: 'status',
                render: function(data, type, row) {
                    return `
                        <select class="form-select form-select-sm status-select" data-id="${row.id}">
                            <option value="open" ${data === 'open' ? 'selected' : ''}>Open</option>
                            <option value="solved" ${data === 'solved' ? 'selected' : ''}>Solved</option>
                            <option value="not_actionable" ${data === 'not_actionable' ? 'selected' : ''}>Not Actionable</option>
                            <option value="merged" ${data === 'merged' ? 'selected' : ''}>Merged</option>
                        </select>
                    `;
                }
            },
            { data: 'created_at' },
            { data: 'updated_at' },
            {
                data: null,
                render: function(data) {
                    return `
                        <div class="btn-group">
                            <a href="/bug_reports/ticket/${data.id}" class="btn btn-sm btn-info no-loader">View</a>
                            <button type="button" class="btn btn-sm btn-danger delete-report" data-id="${data.id}">Delete</button>
                        </div>
                    `;
                },
                orderable: false
            }
        ],
        order: [[1, 'desc']],
        pageLength: 25
    });

    // Handle filter form submission
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        if (DEBUG) console.log('Filter form submitted');
        window.hideAjaxLoader(); // Prevent loader
        table.ajax.reload();
    });

    // Handle filter reset
    $('#resetFilters').on('click', function() {
        if (DEBUG) console.log('Resetting filters');
        this.form.reset();
        window.hideAjaxLoader(); // Prevent loader
        table.ajax.reload();
    });

    // Handle select all checkbox
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.report-select');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
        updateBulkDeleteButton();
    });

    // Handle individual checkboxes
    $(document).on('change', '.report-select', updateBulkDeleteButton);

    // Update bulk delete button state
    function updateBulkDeleteButton() {
        const selectedCount = document.querySelectorAll('.report-select:checked').length;
        document.getElementById('bulkDelete').disabled = selectedCount === 0;
    }

    // Handle status changes
    $(document).on('change', '.status-select', function() {
        const reportId = this.dataset.id;
        const newStatus = this.value;
        
        window.hideAjaxLoader(); // Prevent loader
        fetch(`/bug_reports/reports/${reportId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ status: newStatus }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('Status updated successfully', 'success');
                table.ajax.reload(null, false); // Reload table data, maintain page
            } else {
                throw new Error(data.message || 'Failed to update status');
            }
        })
        .catch(error => {
            showToast(error.message, 'error');
            this.value = this.dataset.originalValue;
        });
    });

    // Handle bulk delete
    document.getElementById('bulkDelete').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.report-select:checked'))
            .map(checkbox => checkbox.dataset.id);
        
        if (selectedIds.length === 0) return;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
        
        document.getElementById('confirmDelete').onclick = function() {
            window.hideAjaxLoader(); // Prevent loader
            Promise.all(selectedIds.map(id => 
                fetch(`/bug_reports/reports/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    credentials: 'same-origin'
                })
            ))
            .then(() => {
                table.ajax.reload();
                modal.hide();
                showToast('Reports deleted successfully', 'success');
            })
            .catch(error => {
                showToast('Error deleting reports: ' + error.message, 'error');
            });
        };
    });

    // Handle export to CSV
    document.getElementById('exportReports').addEventListener('click', function() {
        window.location.href = '/bug_reports/export';
    });

    // Utility function to show toasts
    function showToast(message, type = 'success') {
        const toast = new bootstrap.Toast(Object.assign(document.createElement('div'), {
            className: `toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3`,
            innerHTML: `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `
        }));
        document.body.appendChild(toast._element);
        toast.show();
    }
});
</script>
{% endblock %}
