{% extends "base.html" %}

{% block title %}Role Management{% endblock %}

{% block styles %}
<style>
.role-card {
    transition: all 0.2s;
}
.role-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.permission-badge {
    font-size: 0.8rem;
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
}
.hierarchy-line {
    border-left: 2px solid #dee2e6;
    margin-left: 1.5rem;
    padding-left: 1.5rem;
}
.role-stats {
    font-size: 0.9rem;
}
.ldap-badge {
    font-size: 0.8rem;
}
.system-role-indicator {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 0.8rem;
}
.hierarchy-view {
    position: relative;
    padding: 1rem;
}
.hierarchy-node {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin: 0.5rem 0;
    background: white;
    transition: all 0.3s ease;
}
.hierarchy-node:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.hierarchy-connector {
    position: absolute;
    border-left: 2px solid #dee2e6;
    height: 20px;
    left: 50%;
    bottom: 100%;
}
.permission-inheritance {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}
.inherited-permission {
    padding: 0.5rem;
    border-left: 3px solid #007bff;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 0 4px 4px 0;
}
.role-audit {
    max-height: 300px;
    overflow-y: auto;
}
.audit-entry {
    padding: 0.75rem;
    border-left: 3px solid #6c757d;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 0 4px 4px 0;
}
.audit-entry:hover {
    background: #f8f9fa;
}
.role-clone-preview {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Admin</a></li>
<li class="breadcrumb-item active">Roles</li>
{% endblock %}

{% block page_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
                <i class="fas fa-user-shield mr-2"></i>Role Management
            </h3>
            <div class="btn-group">
                <button type="button" class="btn btn-info" onclick="showHierarchyView()">
                    <i class="fas fa-sitemap mr-1"></i>Hierarchy View
                </button>
                <button type="button" class="btn btn-success" onclick="showPermissionInheritance()">
                    <i class="fas fa-project-diagram mr-1"></i>Permission Inheritance
                </button>
                <a href="{{ url_for('admin.new_role') }}" class="btn btn-primary">
                    <i class="fas fa-plus mr-1"></i>New Role
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters and Search -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <input type="text" class="form-control" id="role-search" 
                           placeholder="Search roles...">
                </div>
            </div>
            <div class="col-md-8">
                <div class="btn-group float-right" role="group">
                    <button type="button" class="btn btn-outline-secondary active" data-view="cards">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-view="tree">
                        <i class="fas fa-sitemap"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-view="table">
                        <i class="fas fa-table"></i>
                    </button>
                </div>
                <div class="btn-group float-right mr-2">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                            data-toggle="dropdown">
                        <i class="fas fa-filter mr-1"></i>Filter
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="#" data-filter="all">All Roles</a>
                        <a class="dropdown-item" href="#" data-filter="system">System Roles</a>
                        <a class="dropdown-item" href="#" data-filter="custom">Custom Roles</a>
                        <a class="dropdown-item" href="#" data-filter="ldap">LDAP-Mapped</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" data-filter="top-level">Top Level</a>
                        <a class="dropdown-item" href="#" data-filter="with-children">With Children</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Views -->
        <div id="roles-container">
            <!-- Card View (Default) -->
            <div id="card-view">
                {% for role in roles recursive %}
                <div class="role-card card mb-3 {{ 'hierarchy-line' if role.parent }}">
                    {% if role.is_system_role %}
                    <div class="system-role-indicator">
                        <span class="badge badge-info">
                            <i class="fas fa-shield-alt mr-1"></i>System Role
                        </span>
                    </div>
                    {% endif %}
                    
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">
                                <i class="fas {{ role.icon }} mr-2"></i>{{ role.name }}
                            </h5>
                            <div class="btn-group">
                                <a href="{{ url_for('admin.edit_role', role_id=role.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('admin.role_members', role_id=role.id) }}" 
                                   class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-users"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="cloneRole({{ role.id }})">
                                    <i class="fas fa-clone"></i>
                                </button>
                                {% if role.ldap_groups %}
                                <a href="{{ url_for('admin.sync_role_ldap', role_id=role.id) }}" 
                                   class="btn btn-sm btn-outline-secondary"
                                   title="Sync LDAP Groups">
                                    <i class="fas fa-sync"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>

                        {% if role.description %}
                        <p class="card-text text-muted mb-3">{{ role.description }}</p>
                        {% endif %}

                        <!-- Role Stats -->
                        <div class="role-stats d-flex mb-3">
                            <div class="mr-3">
                                <i class="fas fa-users mr-1"></i>
                                {{ role.users|length }} Users
                            </div>
                            <div class="mr-3">
                                <i class="fas fa-key mr-1"></i>
                                {{ role.permissions|length }} Permissions
                            </div>
                            {% if role.children %}
                            <div>
                                <i class="fas fa-sitemap mr-1"></i>
                                {{ role.children|length }} Child Roles
                            </div>
                            {% endif %}
                        </div>

                        <!-- Permissions Preview -->
                        <div class="mb-3">
                            {% for perm in role.permissions[:5] %}
                            <span class="badge badge-secondary permission-badge">
                                {{ perm.name }}
                            </span>
                            {% endfor %}
                            {% if role.permissions|length > 5 %}
                            <span class="badge badge-light permission-badge">
                                +{{ role.permissions|length - 5 }} more
                            </span>
                            {% endif %}
                        </div>

                        <!-- LDAP Integration -->
                        {% if role.ldap_groups %}
                        <div class="ldap-integration">
                            <small class="text-muted">LDAP Groups:</small>
                            {% for group in role.ldap_groups %}
                            <span class="badge badge-info ldap-badge">
                                <i class="fas fa-users-cog mr-1"></i>{{ group }}
                            </span>
                            {% endfor %}
                            {% if role.auto_sync %}
                            <span class="badge badge-success ldap-badge">
                                <i class="fas fa-sync-alt mr-1"></i>Auto-sync
                            </span>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Audit Log Preview -->
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="viewAuditLog({{ role.id }})">
                                <i class="fas fa-history mr-1"></i>View Audit Log
                            </button>
                        </div>
                    </div>

                    <!-- Child Roles -->
                    {% if role.children %}
                        {{ loop(role.children) }}
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- Tree View -->
            <div id="tree-view" class="d-none">
                <div id="role-tree"></div>
            </div>

            <!-- Table View -->
            <div id="table-view" class="d-none">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Users</th>
                            <th>Permissions</th>
                            <th>Parent</th>
                            <th>LDAP Groups</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr>
                            <td>
                                <i class="fas {{ role.icon }} mr-2"></i>
                                {{ role.name }}
                                {% if role.is_system_role %}
                                <span class="badge badge-info">System</span>
                                {% endif %}
                            </td>
                            <td>{{ role.users|length }}</td>
                            <td>{{ role.permissions|length }}</td>
                            <td>
                                {% if role.parent %}
                                {{ role.parent.name }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if role.ldap_groups %}
                                {% for group in role.ldap_groups %}
                                <span class="badge badge-info">{{ group }}</span>
                                {% endfor %}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('admin.edit_role', role_id=role.id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('admin.role_members', role_id=role.id) }}" 
                                       class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-users"></i>
                                    </a>
                                    {% if role.ldap_groups %}
                                    <a href="{{ url_for('admin.sync_role_ldap', role_id=role.id) }}" 
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-sync"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Hierarchy View Modal -->
<div class="modal fade" id="hierarchyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Role Hierarchy</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="hierarchy-view" id="hierarchyView">
                    <!-- Hierarchy will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Permission Inheritance Modal -->
<div class="modal fade" id="inheritanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Permission Inheritance</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Role</label>
                    <select class="form-control" id="inheritanceRoleSelect">
                        {% for role in roles %}
                        <option value="{{ role.id }}">{{ role.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="inheritanceView">
                    <!-- Inheritance will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audit Log Modal -->
<div class="modal fade" id="auditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Role Audit Log</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="role-audit" id="auditLog">
                    <!-- Audit log will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clone Role Modal -->
<div class="modal fade" id="cloneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clone Role</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="cloneForm">
                    <div class="form-group">
                        <label>New Role Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Clone Options</label>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" 
                                   id="clonePermissions" checked>
                            <label class="custom-control-label" for="clonePermissions">
                                Clone Permissions
                            </label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" 
                                   id="cloneHierarchy" checked>
                            <label class="custom-control-label" for="cloneHierarchy">
                                Clone Hierarchy
                            </label>
                        </div>
                    </div>
                    <div class="role-clone-preview">
                        <h6>Preview</h6>
                        <div id="clonePreview">
                            <!-- Clone preview will be populated by JavaScript -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processClone()">
                    <i class="fas fa-clone mr-1"></i>Clone Role
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // View switching
    $('[data-view]').click(function() {
        const view = $(this).data('view');
        
        // Update active button
        $('[data-view]').removeClass('active');
        $(this).addClass('active');
        
        // Show selected view
        $('#card-view, #tree-view, #table-view').addClass('d-none');
        $(`#${view}-view`).removeClass('d-none');
        
        // Load tree view if selected
        if (view === 'tree') {
            loadRoleTree();
        }
    });
    
    // Role search
    $('#role-search').on('input', function() {
        const search = $(this).val().toLowerCase();
        $('.role-card').each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(search));
        });
    });
    
    // Role filtering
    $('[data-filter]').click(function(e) {
        e.preventDefault();
        const filter = $(this).data('filter');
        
        $('.role-card').show();
        
        switch(filter) {
            case 'system':
                $('.role-card:not(:has(.system-role-indicator))').hide();
                break;
            case 'custom':
                $('.role-card:has(.system-role-indicator)').hide();
                break;
            case 'ldap':
                $('.role-card:not(:has(.ldap-integration))').hide();
                break;
            case 'top-level':
                $('.role-card:has(.hierarchy-line)').hide();
                break;
            case 'with-children':
                $('.role-card:not(:has(.role-card))').hide();
                break;
        }
    });

    // Initialize inheritance view
    $('#inheritanceRoleSelect').change(function() {
        updateInheritanceView($(this).val());
    });
});

function showHierarchyView() {
    loadHierarchyView();
    $('#hierarchyModal').modal('show');
}

function loadHierarchyView() {
    // Simulate loading hierarchy data
    const hierarchy = {
        id: 1,
        name: 'Admin',
        children: [
            {
                id: 2,
                name: 'Manager',
                children: [
                    {
                        id: 3,
                        name: 'User',
                        children: []
                    }
                ]
            }
        ]
    };

    const buildHierarchyHtml = (node, level = 0) => {
        const margin = level * 40;
        let html = `
            <div class="hierarchy-node" style="margin-left: ${margin}px">
                <h6 class="mb-0">${node.name}</h6>
                ${level > 0 ? '<div class="hierarchy-connector"></div>' : ''}
            </div>
        `;
        
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                html += buildHierarchyHtml(child, level + 1);
            });
        }
        
        return html;
    };

    document.getElementById('hierarchyView').innerHTML = buildHierarchyHtml(hierarchy);
}

function showPermissionInheritance() {
    $('#inheritanceModal').modal('show');
    updateInheritanceView($('#inheritanceRoleSelect').val());
}

function updateInheritanceView(roleId) {
    // Simulate loading inheritance data
    const inheritance = [
        {
            role: 'Admin',
            permissions: ['create_user', 'delete_user', 'manage_roles']
        },
        {
            role: 'Manager',
            permissions: ['view_users', 'edit_users']
        }
    ];

    const html = inheritance.map(item => `
        <div class="permission-inheritance">
            <h6>${item.role}</h6>
            ${item.permissions.map(perm => `
                <div class="inherited-permission">
                    <i class="fas fa-key mr-2"></i>${perm}
                </div>
            `).join('')}
        </div>
    `).join('');

    document.getElementById('inheritanceView').innerHTML = html;
}

function viewAuditLog(roleId) {
    // Simulate loading audit log
    const auditLog = [
        {
            action: 'Permission Added',
            user: 'admin',
            timestamp: '2024-01-01 10:00:00',
            details: 'Added permission: manage_users'
        },
        {
            action: 'Role Updated',
            user: 'admin',
            timestamp: '2024-01-01 09:30:00',
            details: 'Updated role description'
        }
    ];

    const html = auditLog.map(entry => `
        <div class="audit-entry">
            <div class="d-flex justify-content-between">
                <strong>${entry.action}</strong>
                <small class="text-muted">${entry.timestamp}</small>
            </div>
            <div class="text-muted">By: ${entry.user}</div>
            <div>${entry.details}</div>
        </div>
    `).join('');

    document.getElementById('auditLog').innerHTML = html;
    $('#auditModal').modal('show');
}

function cloneRole(roleId) {
    // Load role data
    const roleData = {
        name: 'Admin',
        permissions: ['create_user', 'delete_user', 'manage_roles'],
        children: ['Manager', 'User']
    };

    // Update clone preview
    const preview = `
        <div class="card">
            <div class="card-body">
                <h6>Original Role: ${roleData.name}</h6>
                <div class="mb-2">
                    <small class="text-muted">Permissions:</small><br>
                    ${roleData.permissions.map(p => 
                        `<span class="badge badge-secondary mr-1">${p}</span>`
                    ).join('')}
                </div>
                <div>
                    <small class="text-muted">Child Roles:</small><br>
                    ${roleData.children.map(r => 
                        `<span class="badge badge-info mr-1">${r}</span>`
                    ).join('')}
                </div>
            </div>
        </div>
    `;

    document.getElementById('clonePreview').innerHTML = preview;
    $('#cloneModal').modal('show');
}

function processClone() {
    const name = document.querySelector('#cloneForm input[name="name"]').value;
    const clonePermissions = document.getElementById('clonePermissions').checked;
    const cloneHierarchy = document.getElementById('cloneHierarchy').checked;

    if (!name) {
        Swal.fire('Error', 'Please enter a name for the new role', 'error');
        return;
    }

    // Simulate cloning process
    Swal.fire({
        title: 'Cloning Role',
        text: 'Please wait...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Simulate API call
    setTimeout(() => {
        $('#cloneModal').modal('hide');
        Swal.fire({
            icon: 'success',
            title: 'Role Cloned',
            text: 'The role has been cloned successfully'
        }).then(() => {
            location.reload();
        });
    }, 1500);
}
</script>
{% endblock %}
