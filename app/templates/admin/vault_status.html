{% extends 'base.html' %}

{% block title %}Vault Status{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Admin</a></li>
<li class="breadcrumb-item active">Vault Status</li>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <!-- Status Overview -->
    <div class="row">
        <div class="col-lg-3 col-6">
            <div class="small-box {% if status.status == 'healthy' %}bg-success{% elif status.status == 'degraded' %}bg-warning{% else %}bg-danger{% endif %}">
                <div class="inner">
                    <h3>{{ status.status|title }}</h3>
                    <p>Overall Status</p>
                </div>
                <div class="icon">
                    <i class="fas {% if status.status == 'healthy' %}fa-check-circle{% elif status.status == 'degraded' %}fa-exclamation-triangle{% else %}fa-times-circle{% endif %}"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="small-box {% if not status.sealed %}bg-success{% else %}bg-danger{% endif %}">
                <div class="inner">
                    <h3>{{ 'Unsealed' if not status.sealed else 'Sealed' }}</h3>
                    <p>Seal Status</p>
                </div>
                <div class="icon">
                    <i class="fas {% if not status.sealed %}fa-unlock{% else %}fa-lock{% endif %}"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="small-box {% if status.initialized %}bg-success{% else %}bg-danger{% endif %}">
                <div class="inner">
                    <h3>{{ 'Yes' if status.initialized else 'No' }}</h3>
                    <p>Initialized</p>
                </div>
                <div class="icon">
                    <i class="fas {% if status.initialized %}fa-check{% else %}fa-times{% endif %}"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="small-box bg-info">
                <div class="inner">
                    <h3>{{ status.version if status.version else 'Unknown' }}</h3>
                    <p>Version</p>
                </div>
                <div class="icon">
                    <i class="fas fa-code-branch"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- System Health Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">System Health</h3>
                </div>
                <div class="card-body">
                    <div id="systemChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Secret Engines Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Secret Engines</h3>
                </div>
                <div class="card-body">
                    <div id="secretEnginesChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">System Information</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table">
                                <tr>
                                    <th style="width: 30%">Cluster Name</th>
                                    <td>{{ status.cluster_name }}</td>
                                </tr>
                                <tr>
                                    <th>Cluster ID</th>
                                    <td>{{ status.cluster_id }}</td>
                                </tr>
                                <tr>
                                    <th>Server Time (UTC)</th>
                                    <td>{{ status.server_time_utc }}</td>
                                </tr>
                                <tr>
                                    <th>Last Check</th>
                                    <td>{{ status.last_check }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Path</th>
                                        <th>Type</th>
                                        <th>Version</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for path, details in summary.mounts.items() %}
                                    <tr>
                                        <td>{{ path }}</td>
                                        <td><span class="badge bg-primary">{{ details.type }}</span></td>
                                        <td>{{ details.options.version if details.options and details.options.version else 'N/A' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Log -->
    {% if status.errors %}
    <div class="row">
        <div class="col-12">
            <div class="card card-danger">
                <div class="card-header">
                    <h3 class="card-title">Errors</h3>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped">
                        <tbody>
                            {% for error in status.errors %}
                            <tr>
                                <td><i class="fas fa-exclamation-circle text-danger"></i> {{ error }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Auto-refresh the page every 30 seconds
    setTimeout(function() {
        location.reload();
    }, 30000);

    // System Health Chart
    Highcharts.chart('systemChart', {
        chart: {
            type: 'gauge',
            plotBackgroundColor: null,
            plotBackgroundImage: null,
            plotBorderWidth: 0,
            plotShadow: false
        },
        title: {
            text: 'System Health'
        },
        pane: {
            startAngle: -150,
            endAngle: 150
        },
        yAxis: {
            min: 0,
            max: 100,
            title: {
                text: 'Health %'
            },
            plotBands: [{
                from: 0,
                to: 60,
                color: '#DF5353'
            }, {
                from: 60,
                to: 80,
                color: '#DDDF0D'
            }, {
                from: 80,
                to: 100,
                color: '#55BF3B'
            }]
        },
        series: [{
            name: 'Health',
            data: [{{ '100' if status.status == 'healthy' else '70' if status.status == 'degraded' else '30' }}],
            tooltip: {
                valueSuffix: ' %'
            }
        }]
    });

    // Secret Engines Chart
    Highcharts.chart('secretEnginesChart', {
        chart: {
            type: 'pie'
        },
        title: {
            text: 'Secret Engines Distribution'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                depth: 35,
                dataLabels: {
                    enabled: true,
                    format: '{point.name}'
                }
            }
        },
        series: [{
            type: 'pie',
            name: 'Count',
            data: [
                {% for path, details in summary.mounts.items() %}
                {
                    name: '{{ details.type }}',
                    y: 1
                },
                {% endfor %}
            ]
        }]
    });
</script>
{% endblock %}
