{% extends "base.html" %}

{% block title %}{{ 'Edit' if role else 'New' }} Role{% endblock %}

{% block styles %}
{{ super() }}
<style>
.icon-grid {
    max-height: 300px;
    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 10px;
    padding: 10px;
}
.icon-option {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}
.icon-option:hover {
    background: #e9ecef;
}
.icon-option.selected {
    background: #007bff;
    color: white;
}
.permission-category {
    transition: all 0.2s;
}
.permission-category:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.select-all {
    font-size: 0.875rem;
    color: #007bff;
    cursor: pointer;
}
.permission-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}
.system-role-warning {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 0.25rem;
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Admin</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.roles') }}">Roles</a></li>
<li class="breadcrumb-item active">{{ 'Edit' if role else 'New' }} Role</li>
{% endblock %}

{% block page_content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-user-shield mr-2"></i>{{ 'Edit' if role else 'New' }} Role
        </h3>
    </div>
    <div class="card-body">
        <form method="POST" id="role-form">
            {{ form.csrf_token }}
            
            <!-- Basic Information -->
            <div class="form-group">
                <label for="name">Role Name</label>
                <input type="text" class="form-control" id="name" name="name" 
                       value="{{ role.name if role else '' }}" required
                       pattern="[a-zA-Z0-9_-]+" 
                       title="Only letters, numbers, underscores and hyphens are allowed"
                       {% if role and role.is_system_role %}readonly{% endif %}>
                <small class="form-text text-muted">
                    Role names can only contain letters, numbers, underscores and hyphens
                </small>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" id="description" name="description" 
                          rows="2" required>{{ role.description if role else '' }}</textarea>
                <small class="form-text text-muted">
                    Provide a clear description of this role's purpose and responsibilities
                </small>
            </div>

            <!-- Icon Picker -->
            <div class="form-group">
                <label for="icon">Icon</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i id="icon-preview" class="fas {{ role.icon if role else 'fa-user-shield' }}"></i>
                        </span>
                    </div>
                    <input type="text" class="form-control" id="icon" name="icon" 
                           value="{{ role.icon if role else 'fa-user-shield' }}" readonly>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" 
                                data-toggle="modal" data-target="#iconPickerModal">
                            <i class="fas fa-th mr-1"></i>Choose Icon
                        </button>
                    </div>
                </div>
            </div>

            <!-- Permissions -->
            <div class="form-group">
                <label>Permissions</label>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle mr-2"></i>
                    Select the permissions this role should have. Users with this role will inherit all selected permissions.
                </div>
                <div class="row">
                    {% for category, perms in permissions.items() %}
                    <div class="col-md-6">
                        <div class="card mb-3 permission-category">
                            <div class="card-header bg-light">
                                <div class="category-header">
                                    <h5 class="mb-0">{{ category|title }}</h5>
                                    <span class="select-all" data-category="{{ category }}">
                                        Select All
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                {% for permission in perms %}
                                <div class="custom-control custom-checkbox mb-2">
                                    <input type="checkbox" class="custom-control-input permission-checkbox" 
                                           id="perm_{{ permission.id }}" 
                                           name="permissions[]" 
                                           value="{{ permission.id }}"
                                           data-category="{{ category }}"
                                           {% if role and permission in role.permissions %}checked{% endif %}>
                                    <label class="custom-control-label" for="perm_{{ permission.id }}">
                                        {{ permission.name }}
                                        <div class="permission-description">
                                            {{ permission.description }}
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- System Role Toggle -->
            <div class="form-group">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="is_system_role" 
                           name="is_system_role" 
                           {% if role and role.is_system_role %}checked disabled{% endif %}
                           {% if not current_user.has_permission('admin_system_roles_access') %}disabled{% endif %}>
                    <label class="custom-control-label" for="is_system_role">System Role</label>
                </div>
                <small class="form-text text-muted">
                    System roles cannot be deleted and are essential for application functionality
                </small>
                {% if not current_user.has_permission('admin_system_roles_access') %}
                <small class="form-text text-warning">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    You need additional permissions to create or modify system roles
                </small>
                {% endif %}
                <div id="systemRoleWarning" class="system-role-warning">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Warning:</strong> Making this a system role cannot be undone. System roles cannot be deleted 
                    and have special privileges in the application.
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary" id="saveButton">
                    <i class="fas fa-save mr-1"></i>Save Role
                </button>
                <a href="{{ url_for('admin.roles') }}" class="btn btn-secondary">
                    <i class="fas fa-times mr-1"></i>Cancel
                </a>
                {% if role and not role.is_system_role %}
                <button type="button" class="btn btn-danger float-right" id="deleteButton">
                    <i class="fas fa-trash mr-1"></i>Delete Role
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Icon Picker Modal -->
<div class="modal fade" id="iconPickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Choose Icon</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <input type="text" class="form-control" id="iconSearch" 
                           placeholder="Search icons...">
                </div>
                <div class="icon-grid" id="iconGrid">
                    <!-- Icons will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Common FontAwesome icons for roles
    const icons = [
        'fa-user-shield', 'fa-users-cog', 'fa-user-lock', 'fa-user-tie',
        'fa-user-cog', 'fa-user-edit', 'fa-user-clock', 'fa-user-check',
        'fa-users', 'fa-user-friends', 'fa-user-graduate', 'fa-user-nurse',
        'fa-user-md', 'fa-user-secret', 'fa-user-tag', 'fa-user-crown',
        'fa-shield-alt', 'fa-lock', 'fa-key', 'fa-cog',
        'fa-tools', 'fa-wrench', 'fa-screwdriver', 'fa-hammer',
        'fa-clipboard-check', 'fa-tasks', 'fa-project-diagram', 'fa-sitemap',
        'fa-chart-line', 'fa-analytics', 'fa-database', 'fa-server'
    ];

    // Populate icon grid
    function populateIcons(searchTerm = '') {
        const $grid = $('#iconGrid').empty();
        const currentIcon = $('#icon').val();
        
        icons.filter(icon => icon.includes(searchTerm.toLowerCase()))
             .forEach(icon => {
                const $option = $(`
                    <div class="icon-option ${icon === currentIcon ? 'selected' : ''}" 
                         data-icon="${icon}">
                        <i class="fas ${icon}"></i>
                    </div>
                `);
                $grid.append($option);
             });
    }

    // Initial icon population
    populateIcons();

    // Icon search
    $('#iconSearch').on('input', function() {
        populateIcons($(this).val());
    });

    // Icon selection
    $(document).on('click', '.icon-option', function() {
        const icon = $(this).data('icon');
        $('#icon').val(icon);
        $('#icon-preview').attr('class', `fas ${icon}`);
        $('.icon-option').removeClass('selected');
        $(this).addClass('selected');
        $('#iconPickerModal').modal('hide');
    });

    // Permission management
    $('.select-all').click(function() {
        const category = $(this).data('category');
        const $checkboxes = $(`.permission-checkbox[data-category="${category}"]`);
        const allChecked = $checkboxes.length === $checkboxes.filter(':checked').length;
        
        $checkboxes.prop('checked', !allChecked);
        $(this).text(allChecked ? 'Select All' : 'Deselect All');
    });

    // Update select all text on checkbox change
    $('.permission-checkbox').change(function() {
        const category = $(this).data('category');
        const $checkboxes = $(`.permission-checkbox[data-category="${category}"]`);
        const $selectAll = $(`.select-all[data-category="${category}"]`);
        const allChecked = $checkboxes.length === $checkboxes.filter(':checked').length;
        
        $selectAll.text(allChecked ? 'Deselect All' : 'Select All');
    });

    // System role warning
    $('#is_system_role').change(function() {
        $('#systemRoleWarning').toggle(this.checked);
    });

    // Form validation
    $('#role-form').submit(function(e) {
        const name = $('#name').val().trim();
        const description = $('#description').val().trim();
        const permissions = $('input[name="permissions[]"]:checked').length;
        
        if (!name) {
            e.preventDefault();
            Swal.fire({
                title: 'Validation Error',
                text: 'Role name is required',
                icon: 'error'
            });
            return;
        }
        
        if (!description) {
            e.preventDefault();
            Swal.fire({
                title: 'Validation Error',
                text: 'Role description is required',
                icon: 'error'
            });
            return;
        }
        
        if (permissions === 0) {
            e.preventDefault();
            Swal.fire({
                title: 'No Permissions Selected',
                text: 'Please select at least one permission for this role',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Save Anyway',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $(this).off('submit').submit();
                }
            });
            return;
        }
        
        if ($('#is_system_role').prop('checked')) {
            e.preventDefault();
            Swal.fire({
                title: 'Confirm System Role',
                text: 'Are you sure you want to make this a system role? This cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Continue',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $(this).off('submit').submit();
                }
            });
        }
    });

    // Delete role confirmation
    $('#deleteButton').click(function(e) {
        e.preventDefault();
        Swal.fire({
            title: 'Delete Role?',
            text: 'Are you sure you want to delete this role? This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Yes, Delete',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "{{ url_for('admin.delete_role', role_id=role.id) if role else '' }}";
            }
        });
    });
});
</script>
{% endblock %}
