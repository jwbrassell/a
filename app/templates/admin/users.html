{% extends "base.html" %}
{% from "admin/components/macros.html" import stat_box, chart_card, data_table, user_info, role_badge, action_buttons %}

{% block title %}User Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Admin</a></li>
<li class="breadcrumb-item active">Users</li>
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/admin/common.css') }}">
{% endblock %}

{% block page_content %}
<!-- User Statistics -->
<div class="row">
    <div class="col-lg-3 col-6">
        {{ stat_box(
            title="Total Users",
            value=users|length,
            icon="users",
            color="info"
        ) }}
    </div>
    <div class="col-lg-3 col-6">
        {{ stat_box(
            title="Active Users",
            value="0",
            icon="user-check",
            color="success",
            footer_text="View active users",
            footer_link="#activeUsers"
        ) }}
    </div>
    <div class="col-lg-3 col-6">
        {{ stat_box(
            title="New Users (Last 30 Days)",
            value="0",
            icon="user-plus",
            color="warning",
            footer_text="View new users",
            footer_link="#newUsers"
        ) }}
    </div>
    <div class="col-lg-3 col-6">
        {{ stat_box(
            title="Inactive Users",
            value="0",
            icon="user-times",
            color="danger",
            footer_text="View inactive users",
            footer_link="#inactiveUsers"
        ) }}
    </div>
</div>

<!-- User Activity Chart -->
<div class="row">
    <div class="col-md-8">
        {% call chart_card("User Activity", "userActivityChart", "chart-line") %}
        {% endcall %}
    </div>
    <div class="col-md-4">
        {% call chart_card("Role Distribution", "roleDistributionChart", "chart-pie") %}
        {% endcall %}
    </div>
</div>

<!-- Users Table -->
{% call data_table("usersTable", 
    ["User", "Email", "Roles", "Status", "Last Login", "Actions"],
    show_tools=true) %}
    <div class="btn-group">
        <button type="button" class="btn btn-success" onclick="admin.handleUserAction('import')">
            <i class="fas fa-file-import mr-1"></i>Import Users
        </button>
        <button type="button" class="btn btn-info" onclick="admin.handleUserAction('export')">
            <i class="fas fa-file-export mr-1"></i>Export Users
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newUserModal">
            <i class="fas fa-user-plus mr-1"></i>New User
        </button>
    </div>
{% endcall %}

<!-- Table Body Content -->
<script type="text/template" id="userRowTemplate">
    <td>
        <div class="user-info">
            <img src="/profile/avatar/${id}" class="user-avatar" alt="User Avatar">
            <span>${username}</span>
        </div>
    </td>
    <td>${email}</td>
    <td>
        ${roles.map(role => `
            <span class="role-badge" data-toggle="tooltip" title="Click to edit roles">
                <i class="${role.icon}"></i>${role.name}
            </span>
        `).join('')}
    </td>
    <td>
        <span class="status-indicator status-${is_active ? 'active' : 'inactive'}"></span>
        ${is_active ? 'Active' : 'Inactive'}
    </td>
    <td>${last_login ? new Date(last_login).toLocaleString() : 'Never'}</td>
    <td>
        {% call action_buttons() %}
            <button class="btn btn-sm btn-info" onclick="admin.handleUserAction('edit', ${id})">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="admin.handleUserAction('resetPassword', ${id})">
                <i class="fas fa-key"></i>
            </button>
            <button class="btn btn-sm btn-primary" onclick="admin.handleUserAction('viewSessions', ${id})">
                <i class="fas fa-desktop"></i>
            </button>
            <button class="btn btn-sm btn-${is_active ? 'danger' : 'success'}" 
                    onclick="admin.handleUserAction('toggleStatus', ${id})">
                <i class="fas fa-${is_active ? 'ban' : 'check'}"></i>
            </button>
        {% endcall %}
    </td>
</script>

<!-- New User Modal -->
<div class="modal fade" id="newUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newUserForm">
                    <div class="form-group mb-3">
                        <label>Username</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Roles</label>
                        <select class="form-control" name="roles" multiple required>
                            {% for role in all_roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="admin.handleUserAction('create')">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" name="id">
                    <div class="form-group mb-3">
                        <label>Username</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Roles</label>
                        <select class="form-control" name="roles" multiple required>
                            {% for role in all_roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="is_active">
                            <label class="form-check-label">Active</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="admin.handleUserAction('update')">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module">
    import { Admin } from "{{ url_for('static', filename='src/js/admin/main.js') }}";

    // Initialize admin dashboard
    document.addEventListener('DOMContentLoaded', function() {
        const admin = new Admin();
        window.admin = admin; // Make available globally for event handlers
        
        // Initialize users dashboard
        admin.initUsersDashboard({
            refreshInterval: 30000 // 30 seconds
        });
    });
</script>
{% endblock %}
