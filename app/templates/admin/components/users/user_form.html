{% from 'admin/components/forms/form_group.html' import form_group, form_select, form_checkbox, form_submit %}

{% macro user_form(user=None, roles=None, action_url="") %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas {% if user %}fa-user-edit{% else %}fa-user-plus{% endif %} mr-2"></i>
            {% if user %}Edit User{% else %}New User{% endif %}
        </h3>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ action_url }}" enctype="multipart/form-data">
            {{ form_group(
                label="Username",
                name="username",
                value=user.username if user else "",
                required=true,
                help_text="Username must be unique and contain only letters, numbers, and underscores"
            ) }}

            {{ form_group(
                label="Email",
                name="email",
                type="email",
                value=user.email if user else "",
                required=true
            ) }}

            {% if not user %}
            {{ form_group(
                label="Password",
                name="password",
                type="password",
                required=true,
                help_text="Password must be at least 8 characters long"
            ) }}

            {{ form_group(
                label="Confirm Password",
                name="confirm_password",
                type="password",
                required=true
            ) }}
            {% endif %}

            {{ form_group(
                label="Full Name",
                name="full_name",
                value=user.full_name if user else "",
                help_text="Optional: Enter user's full name"
            ) }}

            {% if roles %}
            <div class="form-group">
                <label>Roles</label>
                <div class="role-checkboxes">
                    {% for role in roles %}
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" 
                               class="custom-control-input" 
                               id="role{{ role.id }}" 
                               name="roles[]" 
                               value="{{ role.id }}"
                               {% if user and role in user.roles %}checked{% endif %}>
                        <label class="custom-control-label" for="role{{ role.id }}">
                            {{ role.name }}
                            {% if role.description %}
                            <small class="text-muted">({{ role.description }})</small>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {{ form_group(
                label="Profile Picture",
                name="avatar",
                type="file",
                help_text="Optional: Upload a profile picture (max 2MB, supported formats: JPG, PNG)"
            ) }}

            {{ form_checkbox(
                label="Active",
                name="is_active",
                checked=user.is_active if user else true,
                help_text="Inactive users cannot log in"
            ) }}

            {{ form_submit(
                label="Save User",
                cancel_url=url_for('admin.users')
            ) }}
        </form>
    </div>
</div>

<style>
.role-checkboxes {
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}
.role-checkboxes .custom-checkbox {
    margin-bottom: 8px;
}
.role-checkboxes .custom-checkbox:last-child {
    margin-bottom: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password validation
    const form = document.querySelector('form');
    const password = document.querySelector('input[name="password"]');
    const confirmPassword = document.querySelector('input[name="confirm_password"]');

    if (form && password && confirmPassword) {
        form.addEventListener('submit', function(e) {
            if (password.value !== confirmPassword.value) {
                e.preventDefault();
                alert('Passwords do not match!');
                return false;
            }
            if (password.value.length < 8) {
                e.preventDefault();
                alert('Password must be at least 8 characters long!');
                return false;
            }
            return true;
        });
    }

    // File input validation
    const avatar = document.querySelector('input[name="avatar"]');
    if (avatar) {
        avatar.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                // Check file size (2MB max)
                if (file.size > 2 * 1024 * 1024) {
                    alert('File size must be less than 2MB');
                    this.value = '';
                    return;
                }
                // Check file type
                const validTypes = ['image/jpeg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    alert('Only JPG and PNG files are allowed');
                    this.value = '';
                    return;
                }
            }
        });
    }
});
</script>
{% endmacro %}
