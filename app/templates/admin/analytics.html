{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Admin</a></li>
<li class="breadcrumb-item active">Analytics</li>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
.chart-container {
    min-height: 300px;
    margin-bottom: 1rem;
}
.metric-card {
    transition: all 0.3s ease;
}
.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.date-range-selector {
    margin-bottom: 1rem;
}
.export-options {
    margin-bottom: 1rem;
}
.trend-indicator {
    margin-left: 0.5rem;
}
.trend-up { color: #00a65a; }
.trend-down { color: #dd4b39; }
</style>
{% endblock %}

{% block page_content %}
<!-- Controls -->
<div class="row">
    <div class="col-md-6">
        <div class="date-range-selector">
            <div class="btn-group">
                <button type="button" class="btn btn-default" data-range="7">7 Days</button>
                <button type="button" class="btn btn-primary active" data-range="30">30 Days</button>
                <button type="button" class="btn btn-default" data-range="90">90 Days</button>
                <button type="button" class="btn btn-default" data-range="365">1 Year</button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="export-options float-right">
            <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="exportData('csv')">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button type="button" class="btn btn-danger" onclick="exportData('pdf')">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Overview Cards -->
<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3 id="activeUsers">0</h3>
                <p>Active Users</p>
            </div>
            <div class="icon">
                <i class="fas fa-users"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3 id="documentAccess">0</h3>
                <p>Document Accesses</p>
            </div>
            <div class="icon">
                <i class="fas fa-file"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner">
                <h3 id="activeProjects">0</h3>
                <p>Active Projects</p>
            </div>
            <div class="icon">
                <i class="fas fa-project-diagram"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3 id="resourceUsage">0</h3>
                <p>Resource Usage</p>
            </div>
            <div class="icon">
                <i class="fas fa-server"></i>
            </div>
        </div>
    </div>
</div>

<!-- Feature Usage -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line mr-1"></i>
                    Feature Usage Trends
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="featureUsageChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-star mr-1"></i>
                    Top Features
                </h3>
            </div>
            <div class="card-body p-0">
                <ul class="products-list product-list-in-card pl-2 pr-2" id="topFeaturesList">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Document Analytics -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-folder mr-1"></i>
                    Popular Categories
                </h3>
            </div>
            <div class="card-body">
                <div id="categoryChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-clock mr-1"></i>
                    Access Patterns
                </h3>
            </div>
            <div class="card-body">
                <div id="accessPatternChart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- Project Performance -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks mr-1"></i>
                    Project Performance
                </h3>
                <div class="card-tools">
                    <select class="form-control" id="projectSelector">
                        <option value="">All Projects</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="projectPerformanceChart" class="chart-container"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="projectMetrics">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Productivity -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users mr-1"></i>
                    Team Performance
                </h3>
            </div>
            <div class="card-body">
                <div id="teamPerformanceChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-trophy mr-1"></i>
                    Team Rankings
                </h3>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped" id="teamRankingsTable">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>Score</th>
                                <th>Trend</th>
                                <th>Members</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Utilization -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-server mr-1"></i>
                    Resource Utilization
                </h3>
                <div class="card-tools">
                    <select class="form-control" id="resourceTypeSelector">
                        <option value="">All Resources</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="resourceUtilizationChart" class="chart-container"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box mb-3">
                            <span class="info-box-icon bg-success">
                                <i class="fas fa-dollar-sign"></i>
                            </span>
                            <div class="info-box-content">
                                <span class="info-box-text">Total Cost</span>
                                <span class="info-box-number" id="totalCost">$0</span>
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <span class="info-box-icon bg-info">
                                <i class="fas fa-chart-pie"></i>
                            </span>
                            <div class="info-box-content">
                                <span class="info-box-text">Average Utilization</span>
                                <span class="info-box-number" id="avgUtilization">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let currentRange = 30;
let charts = {};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    refreshData();
});

function setupEventListeners() {
    // Date range buttons
    document.querySelectorAll('.date-range-selector button').forEach(button => {
        button.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.date-range-selector button').forEach(b => {
                b.classList.remove('btn-primary', 'active');
                b.classList.add('btn-default');
            });
            this.classList.remove('btn-default');
            this.classList.add('btn-primary', 'active');
            
            // Update data
            currentRange = parseInt(this.dataset.range);
            refreshData();
        });
    });

    // Project selector
    document.getElementById('projectSelector').addEventListener('change', function() {
        updateProjectData(this.value);
    });

    // Resource type selector
    document.getElementById('resourceTypeSelector').addEventListener('change', function() {
        updateResourceData(this.value);
    });
}

function initializeCharts() {
    // Feature Usage Chart
    charts.featureUsage = Highcharts.chart('featureUsageChart', {
        chart: { type: 'spline' },
        title: { text: 'Feature Usage Trends' },
        xAxis: { type: 'datetime' },
        yAxis: { title: { text: 'Usage Count' } },
        series: []
    });

    // Category Chart
    charts.category = Highcharts.chart('categoryChart', {
        chart: { type: 'pie' },
        title: { text: 'Document Categories' },
        series: [{
            name: 'Access Count',
            data: []
        }]
    });

    // Access Pattern Chart
    charts.accessPattern = Highcharts.chart('accessPatternChart', {
        chart: { type: 'column' },
        title: { text: 'Access Patterns' },
        xAxis: { categories: [] },
        yAxis: { title: { text: 'Count' } },
        series: [{
            name: 'Access Count',
            data: []
        }]
    });

    // Project Performance Chart
    charts.projectPerformance = Highcharts.chart('projectPerformanceChart', {
        chart: { type: 'line' },
        title: { text: 'Project Performance' },
        xAxis: { type: 'datetime' },
        yAxis: { title: { text: 'Score' } },
        series: []
    });

    // Team Performance Chart
    charts.teamPerformance = Highcharts.chart('teamPerformanceChart', {
        chart: { type: 'column' },
        title: { text: 'Team Performance' },
        xAxis: { categories: [] },
        yAxis: { title: { text: 'Score' } },
        series: []
    });

    // Resource Utilization Chart
    charts.resourceUtilization = Highcharts.chart('resourceUtilizationChart', {
        chart: { type: 'area' },
        title: { text: 'Resource Utilization' },
        xAxis: { type: 'datetime' },
        yAxis: { 
            title: { text: 'Utilization %' },
            max: 100
        },
        series: []
    });
}

function refreshData() {
    fetch(`/admin/api/analytics/overview?days=${currentRange}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboard(data.data);
            } else {
                console.error('Error fetching analytics:', data.error);
            }
        })
        .catch(error => console.error('Error:', error));
}

function updateDashboard(data) {
    // Update overview cards
    document.getElementById('activeUsers').textContent = data.feature_usage.user_engagement.active_users;
    document.getElementById('documentAccess').textContent = data.document_analytics.total_access;
    document.getElementById('activeProjects').textContent = data.project_performance.active_projects;
    document.getElementById('resourceUsage').textContent = 
        Math.round(data.resource_utilization.avg_utilization) + '%';
    
    // Update charts
    updateFeatureUsageChart(data.feature_usage);
    updateDocumentAnalytics(data.document_analytics);
    updateProjectPerformance(data.project_performance);
    updateTeamProductivity(data.team_productivity);
    updateResourceUtilization(data.resource_utilization);
}

function updateFeatureUsageChart(data) {
    // Update chart
    charts.featureUsage.update({
        series: data.popular_features.map(feature => ({
            name: feature.feature,
            data: feature.usage_data
        }))
    }, true);

    // Update top features list
    const topFeaturesList = document.getElementById('topFeaturesList');
    topFeaturesList.innerHTML = data.popular_features
        .map(feature => `
            <li class="item">
                <div class="product-info">
                    <a href="javascript:void(0)" class="product-title">
                        ${feature.feature}
                        <span class="badge badge-info float-right">${feature.usage_count}</span>
                    </a>
                    <span class="product-description">
                        Avg. Duration: ${Math.round(feature.avg_duration)}s
                        Success Rate: ${Math.round(feature.success_rate * 100)}%
                    </span>
                </div>
            </li>
        `).join('');
}

function updateDocumentAnalytics(data) {
    // Update category chart
    charts.category.series[0].setData(data.popular_categories);

    // Update access pattern chart
    charts.accessPattern.update({
        xAxis: {
            categories: data.access_patterns.map(p => `${p.hour}:00`)
        },
        series: [{
            name: 'Access Count',
            data: data.access_patterns.map(p => p.count)
        }]
    }, true);
}

function updateProjectPerformance(data) {
    // Update project selector
    const projectSelector = document.getElementById('projectSelector');
    projectSelector.innerHTML = '<option value="">All Projects</option>' +
        Object.keys(data.projects).map(id => 
            `<option value="${id}">Project ${id}</option>`
        ).join('');

    // Update chart with all projects
    const series = [];
    Object.entries(data.projects).forEach(([projectId, metrics]) => {
        Object.entries(metrics).forEach(([metricName, values]) => {
            series.push({
                name: `Project ${projectId} - ${metricName}`,
                data: values.map(v => [v.timestamp, v.avg])
            });
        });
    });

    charts.projectPerformance.update({ series }, true);
}

function updateTeamProductivity(data) {
    const teams = Object.entries(data.teams);
    
    // Update team performance chart
    charts.teamPerformance.update({
        xAxis: {
            categories: teams.map(([id]) => `Team ${id}`)
        },
        series: [{
            name: 'Productivity Score',
            data: teams.map(([, team]) => team.productivity_score)
        }]
    }, true);

    // Update rankings table
    document.getElementById('teamRankingsTable').querySelector('tbody').innerHTML =
        teams
            .sort((a, b) => b[1].productivity_score - a[1].productivity_score)
            .map(([id, team]) => `
                <tr>
                    <td>Team ${id}</td>
                    <td>${Math.round(team.productivity_score)}</td>
                    <td>
                        <i class="fas fa-arrow-${team.trend > 0 ? 'up trend-up' : 'down trend-down'}"></i>
                        ${Math.abs(team.trend)}%
                    </td>
                    <td>${team.active_users}</td>
                </tr>
            `).join('');
}

function updateResourceUtilization(data) {
    // Update resource type selector
    const resourceTypeSelector = document.getElementById('resourceTypeSelector');
    resourceTypeSelector.innerHTML = '<option value="">All Resources</option>' +
        Object.keys(data.metrics).map(type => 
            `<option value="${type}">${type}</option>`
        ).join('');

    // Update chart
    charts.resourceUtilization.update({
        series: Object.entries(data.metrics).map(([type, metrics]) => ({
            name: type,
            data: metrics.utilization_data
        }))
    }, true);

    // Update cost metrics
    document.getElementById('totalCost').textContent = 
        '$' + Math.round(data.total_cost).toLocaleString();
    document.getElementById('avgUtilization').textContent =
        Math.round(data.avg_utilization) + '%';
}

function exportData(format) {
    const params = new URLSearchParams({
        type: 'all',
        days: currentRange,
        format: format
    });

    window.location.href = `/admin/api/analytics/export?${params.toString()}`;
}
</script>
{% endblock %}
