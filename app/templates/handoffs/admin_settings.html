{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
.shift-entry {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.shift-entry .form-control {
    flex: 1;
}

.priority-entry {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.priority-entry .form-control {
    flex: 1;
}

.color-preview {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    border: 1px solid #ced4da;
}
</style>
{% endblock %}

{% block page_content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Handoff Settings</h3>
            </div>
            <div class="card-body">
                <form id="settings-form" method="POST" action="{{ url_for('handoffs.admin_settings') }}">
                    {{ form.csrf_token }}
                    
                    <div class="mb-4">
                        {{ form.workcenter.label(class="form-label") }}
                        {{ form.workcenter(class="form-select") }}
                        {% if form.workcenter.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.workcenter.errors %}
                            <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <h4>Shifts</h4>
                        <p class="text-muted">Define the shifts that can hand off work to each other.</p>
                        
                        <div id="shifts-container">
                            {% for shift in form.shifts %}
                            <div class="shift-entry">
                                {{ shift(class="form-control") }}
                                <button type="button" class="btn btn-danger remove-shift">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <button type="button" class="btn btn-secondary" id="add-shift">
                            <i class="fas fa-plus"></i> Add Shift
                        </button>
                    </div>

                    <div class="mb-4">
                        <h4>Priorities</h4>
                        <p class="text-muted">Define priority levels and their colors.</p>
                        
                        <div id="priorities-container">
                            <!-- Priorities are managed via JavaScript -->
                        </div>
                        
                        <button type="button" class="btn btn-secondary" id="add-priority">
                            <i class="fas fa-plus"></i> Add Priority
                        </button>
                    </div>

                    <div class="mb-4">
                        <h4>Close Options</h4>
                        
                        <div class="form-check mb-2">
                            {{ form.require_close_comment(class="form-check-input") }}
                            {{ form.require_close_comment.label(class="form-check-label") }}
                            {% if form.require_close_comment.description %}
                            <div class="form-text">{{ form.require_close_comment.description }}</div>
                            {% endif %}
                        </div>

                        <div class="form-check">
                            {{ form.allow_close_with_comment(class="form-check-input") }}
                            {{ form.allow_close_with_comment.label(class="form-check-label") }}
                            {% if form.allow_close_with_comment.description %}
                            <div class="form-text">{{ form.allow_close_with_comment.description }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('handoffs.workcenter_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Work Centers
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Set up CSRF token for AJAX requests
    var csrftoken = $('input[name=csrf_token]').val();
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    // Handle dynamic shifts
    $('#add-shift').click(function() {
        const shiftEntry = `
            <div class="shift-entry">
                <input type="text" class="form-control shift-input" required>
                <button type="button" class="btn btn-danger remove-shift">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        $('#shifts-container').append(shiftEntry);
    });

    $(document).on('click', '.remove-shift', function() {
        $(this).closest('.shift-entry').remove();
    });

    // Handle dynamic priorities
    function loadPriorities() {
        const workcenter_id = $('#workcenter').val();
        $.get(`/handoffs/admin/api/priorities?workcenter=${workcenter_id}`, function(data) {
            $('#priorities-container').empty();
            Object.entries(data.priorities || {}).forEach(([name, color]) => {
                addPriorityEntry(name, color);
            });
        });
    }

    function addPriorityEntry(name = '', color = 'info') {
        const priorityEntry = `
            <div class="priority-entry">
                <input type="text" class="form-control priority-name" value="${name}" placeholder="Priority Name" required>
                <select class="form-select priority-color" style="width: auto;">
                    <option value="info" ${color === 'info' ? 'selected' : ''}>Info (Blue)</option>
                    <option value="success" ${color === 'success' ? 'selected' : ''}>Success (Green)</option>
                    <option value="warning" ${color === 'warning' ? 'selected' : ''}>Warning (Yellow)</option>
                    <option value="danger" ${color === 'danger' ? 'selected' : ''}>Danger (Red)</option>
                </select>
                <div class="color-preview bg-${color}"></div>
                <button type="button" class="btn btn-danger remove-priority">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        $('#priorities-container').append(priorityEntry);
    }

    $('#add-priority').click(function() {
        addPriorityEntry();
    });

    $(document).on('click', '.remove-priority', function() {
        $(this).closest('.priority-entry').remove();
    });

    $(document).on('change', '.priority-color', function() {
        const color = $(this).val();
        $(this).next('.color-preview').removeClass().addClass(`color-preview bg-${color}`);
    });

    // Handle form submission
    $('#settings-form').submit(function(e) {
        e.preventDefault();
        
        // Collect shifts
        const shifts = [];
        $('.shift-input').each(function() {
            const value = $(this).val().trim();
            if (value) {
                shifts.push(value);
            }
        });
        
        // Collect priorities
        const priorities = {};
        $('.priority-entry').each(function() {
            const name = $(this).find('.priority-name').val().trim();
            const color = $(this).find('.priority-color').val();
            if (name) {
                priorities[name] = color;
            }
        });

        // Create settings object
        const settings = {
            workcenter_id: $('#workcenter').val(),
            shifts: shifts,
            priorities: priorities,
            require_close_comment: $('#require_close_comment').is(':checked'),
            allow_close_with_comment: $('#allow_close_with_comment').is(':checked')
        };

        console.log('Sending settings:', settings);  // Debug log

        // Submit settings
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(settings),
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                console.log('Response:', response);  // Debug log
                if (response.status === 'success') {
                    window.location.href = "{{ url_for('handoffs.workcenter_list') }}";
                } else {
                    alert('Failed to save settings');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);  // Debug log
                alert('Failed to save settings');
            }
        });
    });

    // Load initial priorities when workcenter changes
    $('#workcenter').change(loadPriorities);
    loadPriorities(); // Load initial priorities

    // Load initial shifts
    const workcenter_id = $('#workcenter').val();
    if (workcenter_id) {
        $.get(`/handoffs/api/shifts?workcenter=${workcenter_id}`, function(data) {
            $('#shifts-container').empty();
            data.shifts.forEach(shift => {
                const shiftEntry = `
                    <div class="shift-entry">
                        <input type="text" class="form-control shift-input" value="${shift}" required>
                        <button type="button" class="btn btn-danger remove-shift">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                $('#shifts-container').append(shiftEntry);
            });
        });
    }
});
</script>
{% endblock %}
